# 模板数据库字段完整说明

本文档详细列出了与模板设计、模板库、模板管理相关的所有数据库字段。

## 一、模板主表 (resume_templates)

### 表名
`resume_templates`

### 字段列表

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 | 用途 |
|--------|------|---------|--------|------|------|
| `id` | Integer | 是 | 自增 | 主键 | 模板唯一标识 |
| `name` | String(255) | 是 | - | 模板名称 | 模板设计、模板库显示 |
| `description` | Text | 否 | NULL | 模板描述 | 模板库展示、模板管理说明 |
| `template_schema` | JSON | 是 | - | 模板结构数据 | **核心字段**：存储模板设计的所有组件、字段、布局信息 |
| `style_config` | JSON | 否 | NULL | 样式配置 | 存储模板的样式设置（字体、颜色、间距等） |
| `is_public` | Boolean | 否 | False | 是否公开 | 模板库：控制模板是否在公共模板库中显示 |
| `is_active` | Boolean | 否 | True | 是否激活 | 模板管理：软删除标记，False表示已删除 |
| `version` | String(50) | 否 | "1.0.0" | 版本号 | 版本管理：模板版本号 |
| `parent_template_id` | Integer | 否 | NULL | 父模板ID | 版本管理：关联父模板（用于版本关联） |
| `usage_count` | Integer | 否 | 0 | 使用次数 | 模板管理：统计模板被使用次数 |
| `created_by` | Integer | 否 | NULL | 创建者ID | 权限管理：关联users表，标识模板创建者 |
| `created_at` | DateTime | 否 | func.now() | 创建时间 | 时间戳 |
| `updated_at` | DateTime | 否 | func.now() | 更新时间 | 时间戳 |

### 索引

1. **单列索引**：
   - `is_public` - 用于查询公开模板
   - `is_active` - 用于查询活跃模板
   - `created_by` - 用于查询用户创建的模板

2. **复合索引**：
   - `idx_template_public_active` (`is_public`, `is_active`) - 查询公开且活跃的模板
   - `idx_template_created_by_active` (`created_by`, `is_active`) - 查询用户创建的活跃模板

### 外键关系

- `parent_template_id` → `resume_templates.id` (自关联，用于版本管理)
- `created_by` → `users.id` (关联用户表)

### 关系映射

- `creator` - 关联到 `User` 模型（创建者）
- `versions` - 一对多关系，关联到 `TemplateVersion` 模型（版本历史）

---

## 二、模板版本历史表 (template_versions)

### 表名
`template_versions`

### 字段列表

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 | 用途 |
|--------|------|---------|--------|------|------|
| `id` | Integer | 是 | 自增 | 主键 | 版本记录唯一标识 |
| `template_id` | Integer | 是 | - | 模板ID | 关联到resume_templates表 |
| `version` | String(50) | 是 | - | 版本号 | 版本管理：如 "1.0.0", "1.1.0" |
| `version_name` | String(255) | 否 | NULL | 版本名称 | 版本管理：如 "初始版本", "添加工作详情组件" |
| `template_schema` | JSON | 是 | - | 模板结构快照 | **核心字段**：保存该版本的完整模板结构 |
| `style_config` | JSON | 否 | NULL | 样式配置快照 | 保存该版本的样式配置 |
| `created_by` | Integer | 否 | NULL | 创建者ID | 关联users表，标识版本创建者 |
| `created_at` | DateTime | 否 | func.now() | 创建时间 | 时间戳，带索引用于排序 |

### 索引

1. **单列索引**：
   - `template_id` - 用于查询模板的所有版本
   - `created_at` - 用于按时间排序

### 外键关系

- `template_id` → `resume_templates.id` (关联模板主表)
- `created_by` → `users.id` (关联用户表)

### 关系映射

- `template` - 多对一关系，关联到 `ResumeTemplate` 模型
- `creator` - 关联到 `User` 模型（创建者）

---

## 三、模板结构数据 (template_schema) 详细说明

### 字段类型
`JSON`

### 数据结构

`template_schema` 是模板的核心数据，存储了模板的完整设计信息。其结构如下：

```json
{
  "components": [
    {
      "id": "component_1",
      "type": "basic_info",
      "title": "基本信息",
      "fields": [
        {
          "id": "name",
          "label": "姓名",
          "type": "text",
          "required": true
        },
        {
          "id": "email",
          "label": "邮箱",
          "type": "email",
          "required": false
        }
      ]
    },
    {
      "id": "component_2",
      "type": "work_experience",
      "title": "工作经历",
      "fields": [...]
    }
  ],
  "style": {
    "font": "Arial",
    "fontSize": 12,
    "color": "#000000"
  },
  "field_mapping": {
    "field_mapping": {
      "basic_info.name": "basic_info.name",
      "basic_info.email": "basic_info.email"
    },
    "complex_fields": []
  }
}
```

### 主要组成部分

1. **components** (数组)
   - 存储模板的所有组件
   - 每个组件包含：
     - `id`: 组件唯一标识
     - `type`: 组件类型（basic_info, work_experience, education, skills, projects等）
     - `title`: 组件标题
     - `fields`: 组件包含的字段列表
       - `id`: 字段唯一标识
       - `label`: 字段标签
       - `type`: 字段类型（text, email, date等）
       - `required`: 是否必填

2. **style** (对象，可选)
   - 存储模板的样式配置
   - 包括字体、字号、颜色、间距等

3. **field_mapping** (对象，可选)
   - 存储AI生成的字段映射规则
   - 用于快速填充模板，减少AI调用
   - 结构：
     - `field_mapping`: 字段映射字典
     - `complex_fields`: 复杂字段列表

---

## 四、样式配置数据 (style_config) 详细说明

### 字段类型
`JSON`

### 数据结构

`style_config` 存储模板的样式设置，结构如下：

```json
{
  "font": "Arial",
  "fontSize": 12,
  "color": "#000000",
  "lineHeight": 1.5,
  "margin": {
    "top": 10,
    "bottom": 10,
    "left": 20,
    "right": 20
  },
  "header": {
    "backgroundColor": "#f0f0f0",
    "padding": 10
  }
}
```

### 主要配置项

- `font`: 字体名称
- `fontSize`: 字号
- `color`: 文字颜色
- `lineHeight`: 行高
- `margin`: 边距设置
- `header`: 页眉样式
- 其他自定义样式配置

---

## 五、模板关联表字段

### CandidateResume 表（推荐报告表）

| 字段名 | 类型 | 说明 | 用途 |
|--------|------|------|------|
| `template_id` | Integer | 模板ID | 关联到resume_templates表，标识使用的模板 |

**外键关系**：
- `template_id` → `resume_templates.id`

**关系映射**：
- `template` - 关联到 `ResumeTemplate` 模型

---

## 六、功能模块与字段对应关系

### 1. 模板设计 (TemplateDesign)

**使用的字段**：
- `template_schema` - 存储设计的模板结构
- `style_config` - 存储样式配置
- `name` - 模板名称
- `description` - 模板描述
- `is_public` - 是否公开

**操作**：
- 创建新模板时，前端发送 `template_schema` 和 `style_config` 到后端
- 后端使用AI分析 `template_schema`，生成 `field_mapping` 并存储

### 2. 模板库 (TemplateLibrary)

**使用的字段**：
- `id` - 模板ID
- `name` - 模板名称
- `description` - 模板描述
- `is_public` - 是否公开（用于筛选）
- `is_active` - 是否激活（用于筛选）
- `template_schema` - 用于预览模板结构
- `style_config` - 用于预览样式
- `created_by` - 创建者（用于权限控制）
- `created_at` - 创建时间（用于排序）
- `usage_count` - 使用次数（用于统计）

**查询条件**：
- 公开模板：`is_public = True AND is_active = True`
- 用户创建的模板：`created_by = current_user.id AND is_active = True`

### 3. 模板管理 (TemplateManagement)

**使用的字段**：
- 所有 `resume_templates` 表的字段
- `template_versions` 表的所有字段（用于版本历史）

**管理功能**：
- 查看模板列表（使用 `is_active` 过滤）
- 编辑模板（更新 `template_schema`, `style_config`, `name`, `description`）
- 删除模板（软删除：设置 `is_active = False`）
- 版本管理（查看 `template_versions` 表）
- 使用统计（查看 `usage_count`）

---

## 七、字段使用场景总结

### 核心设计字段
- `template_schema` - **最重要**，存储模板的完整设计
- `style_config` - 存储样式配置

### 权限控制字段
- `is_public` - 控制模板是否公开
- `is_active` - 控制模板是否可用（软删除）
- `created_by` - 标识创建者，用于权限控制

### 版本管理字段
- `version` - 当前版本号
- `parent_template_id` - 父模板ID（用于版本关联）
- `template_versions` 表 - 存储所有版本历史

### 统计字段
- `usage_count` - 使用次数统计
- `created_at` / `updated_at` - 时间戳

### 元数据字段
- `name` - 模板名称
- `description` - 模板描述
- `id` - 唯一标识

---

## 八、数据库索引优化

### 已创建的索引

1. **单列索引**：
   - `is_public` - 优化公开模板查询
   - `is_active` - 优化活跃模板查询
   - `created_by` - 优化用户模板查询
   - `template_id` (template_versions) - 优化版本查询
   - `created_at` (template_versions) - 优化版本排序

2. **复合索引**：
   - `idx_template_public_active` - 优化公开且活跃的模板查询
   - `idx_template_created_by_active` - 优化用户创建的活跃模板查询

### 查询优化建议

- 查询公开模板时，使用 `idx_template_public_active` 索引
- 查询用户模板时，使用 `idx_template_created_by_active` 索引
- 查询模板版本时，使用 `template_id` 索引

---

## 九、注意事项

1. **template_schema 字段**：
   - 是JSON类型，存储模板的完整结构
   - 包含 `components`, `style`, `field_mapping` 等子结构
   - 在创建模板时，后端会使用AI分析并生成 `field_mapping`

2. **软删除机制**：
   - 删除模板时，不真正删除记录，而是设置 `is_active = False`
   - 查询时需要使用 `is_active = True` 过滤

3. **版本管理**：
   - 每次更新模板时，会创建新的版本记录到 `template_versions` 表
   - `parent_template_id` 用于关联版本关系

4. **权限控制**：
   - `created_by` 字段用于标识模板创建者
   - `is_public` 字段控制模板是否在公共模板库中显示
   - 只有创建者和管理员可以编辑/删除模板

---

## 十、API端点与字段对应

### 创建模板 (POST /templates/)
**请求字段**：
- `name` (必填)
- `description` (可选)
- `is_public` (可选，默认False)
- `template_schema` (必填)
- `style_config` (可选)

**响应字段**：
- 所有 `resume_templates` 表的字段

### 更新模板 (PUT /templates/{template_id})
**可更新字段**：
- `name`
- `description`
- `is_public`
- `template_schema`
- `style_config`

### 查询模板列表 (GET /templates/)
**查询参数**：
- `is_public` - 筛选公开模板
- `is_active` - 筛选活跃模板（默认True）
- `created_by` - 筛选创建者

**返回字段**：
- 所有 `resume_templates` 表的字段

### 查询模板详情 (GET /templates/{template_id})
**返回字段**：
- 所有 `resume_templates` 表的字段
- 关联的版本历史（`template_versions` 表）

---

## 总结

模板系统主要涉及两个数据库表：
1. **resume_templates** - 模板主表，存储模板的核心信息
2. **template_versions** - 模板版本历史表，存储模板的版本快照

核心字段是 `template_schema`（JSON类型），它存储了模板的完整设计结构，包括组件、字段、样式和字段映射规则。

