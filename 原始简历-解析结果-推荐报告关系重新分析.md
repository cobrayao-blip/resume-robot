# 原始简历、解析结果、推荐报告关系重新分析

## 一、业务场景重新理解

### 用户角色
- **用户**：猎头
- **目标**：为候选人生成规范化简历（推荐报告），推荐给用人单位

### 数据实体重新定义

#### 1. 原始简历（源文件）
- **定义**：候选人上传的原始简历文件（PDF/Word）
- **存储**：文件系统（`uploads` 目录）+ 数据库元数据
- **用途**：作为解析的输入源
- **特点**：一个原始简历可以解析多次

#### 2. 解析结果（ParsedResume）
- **定义**：从原始简历中提取的结构化数据（JSON格式）
- **存储**：PostgreSQL 数据库（`parsed_resumes` 表）
- **用途**：作为生成推荐报告的中间数据
- **特点**：一个解析结果可以生成多个推荐报告（使用不同模板）
- **保存方式**：手动保存（用户可控）

#### 3. 推荐报告（UserResume - 需要重命名）
- **定义**：猎头基于解析结果和模板生成的规范化Word文档（给用人单位的）
- **存储**：PostgreSQL 数据库（`user_resumes` 表，存储填充后的数据）+ 可导出Word文件
- **用途**：最终交付给用人单位的规范化简历
- **特点**：一个推荐报告关联一个解析结果 + 一个模板
- **问题**：`UserResume` 字段名不合适，应该改为 `CandidateResume` 或 `RecommendedResume`

---

## 二、数据结构重新设计

### 问题1：UserResume 字段名不合适

#### 当前问题
- `UserResume` 暗示这是"用户的简历"
- 实际是"猎头推荐的候选人的简历"
- 容易产生歧义

#### 重命名建议

**选项A：CandidateResume（推荐）**
- 含义：候选人的简历
- 优点：清晰表达业务含义
- 缺点：需要数据库迁移

**选项B：RecommendedResume**
- 含义：推荐报告
- 优点：强调"推荐"属性
- 缺点：可能不够直观

**选项C：ResumeReport**
- 含义：简历报告
- 优点：中性，不涉及业务角色
- 缺点：可能不够具体

**推荐**：`CandidateResume`（候选人的简历）

### 问题2：缺少数据中心统一管理

#### 当前状态
- 原始简历：在"我的简历"页面的"源文件列表"Tab
- 解析结果：独立的"简历解析"页面
- 推荐报告：在"我的简历"页面的"简历列表"Tab

#### 问题
- 三个模块分散在不同页面
- 无法统一查看和管理
- 关联关系不清晰

#### 解决方案：创建"数据中心"模块

**数据中心页面结构**：
```
数据中心
├── Tab 1：原始简历（所有上传的原始简历文件）
├── Tab 2：解析结果（所有解析结果）
└── Tab 3：推荐报告（所有生成的推荐报告）
```

**优势**：
- 统一管理，便于查看关联关系
- 清晰展示三者之间的关系
- 提供统一的搜索和筛选

---

## 三、数据中心设计讨论

### 方案A：独立的数据中心页面（推荐）

#### 页面结构
- **导航**：新增"数据中心"菜单项
- **布局**：三个Tab，每个Tab一个列表
- **功能**：统一搜索、筛选、管理

#### Tab 1：原始简历
**表格字段设计**：
- 文件名
- 文件类型（PDF/Word）
- 文件大小
- 上传时间
- 解析次数（关联的解析结果数量）
- 最新解析结果（可点击跳转）
- 已生成推荐报告数量
- 操作：预览、下载、删除、解析

#### Tab 2：解析结果
**表格字段设计**：
- 解析结果名称（如"张三详细解析结果"）
- 来源文件（原始简历文件名，可点击查看）
- 解析质量（评分/状态）
- 解析时间
- 已生成推荐报告数量（可点击查看列表）
- 操作：查看详情、生成推荐报告、删除

#### Tab 3：推荐报告
**表格字段设计**：
- 报告标题（如"张三-技术岗推荐报告"）
- 候选人姓名（从解析结果中提取）
- 来源解析结果（可点击跳转）
- 使用模板（可点击查看）
- 生成时间
- 操作：预览、导出Word、重新生成、删除

#### 关联关系显示
- 在每个Tab中，显示关联的其他Tab数据
- 提供快捷操作，如"查看关联的解析结果"、"查看关联的推荐报告"

### 方案B：保持当前结构，优化关联显示

#### 保持当前页面
- "我的简历"：推荐报告列表 + 源文件列表
- "简历解析"：解析结果列表

#### 优化关联显示
- 在推荐报告列表中，显示"来源解析结果"、"原始文件"
- 在解析结果列表中，显示"已生成推荐报告"、"来源文件"
- 在源文件列表中，显示"已解析次数"、"已生成推荐报告数量"

#### 优点
- 改动小，风险低
- 保持当前模块结构

#### 缺点
- 仍然分散在不同页面
- 无法统一管理

---

## 四、表格字段重新设计

### Tab 1：原始简历列表

#### 核心字段
1. **文件名**（主要标识）
   - 显示：原始文件名
   - 操作：可点击下载

2. **文件类型**
   - 显示：PDF / Word
   - 图标：文件类型图标

3. **文件大小**
   - 显示：如"2.5 MB"
   - 用途：了解文件大小

4. **上传时间**
   - 显示：YYYY-MM-DD HH:mm
   - 排序：支持按时间排序

5. **解析状态**
   - 显示：已解析 / 未解析
   - 如果已解析：显示"已解析 X 次"，可点击查看解析结果列表

6. **推荐报告数量**
   - 显示：已生成 X 个推荐报告
   - 可点击：查看推荐报告列表

7. **操作**
   - 预览：预览原始文件
   - 下载：下载原始文件
   - 解析：跳转到解析页面
   - 删除：删除原始文件（提示是否删除关联数据）

#### 可选字段
- 文件hash（用于去重，但用户不需要看到）
- 文件路径（系统内部使用）

### Tab 2：解析结果列表

#### 核心字段
1. **解析结果名称**（主要标识）
   - 显示：如"张三详细解析结果"
   - 生成规则：候选人姓名 + "详细解析结果"

2. **候选人姓名**
   - 显示：从解析数据中提取的姓名
   - 用途：快速识别

3. **来源文件**
   - 显示：原始文件名（可点击查看原始文件）
   - 用途：追溯来源

4. **解析质量**
   - 显示：评分（如"85分"）或状态（优秀/良好/一般）
   - 颜色：绿色/黄色/红色
   - 用途：快速判断解析质量

5. **解析时间**
   - 显示：YYYY-MM-DD HH:mm
   - 排序：支持按时间排序

6. **推荐报告数量**
   - 显示：已生成 X 个推荐报告
   - 可点击：查看推荐报告列表
   - 用途：了解使用情况

7. **操作**
   - 查看详情：查看完整解析结果
   - 生成推荐报告：跳转到简历生成页面
   - 重新解析：如果解析质量不好，可以重新解析
   - 删除：删除解析结果（提示是否删除关联的推荐报告）

#### 可选字段
- 文件hash（用于去重）
- 验证结果（是否有错误）
- 纠错结果（是否已纠错）

### Tab 3：推荐报告列表

#### 核心字段
1. **报告标题**（主要标识）
   - 显示：如"张三-技术岗推荐报告"
   - 生成规则：候选人姓名 + "-" + 模板名称

2. **候选人姓名**
   - 显示：从解析数据中提取的姓名
   - 用途：快速识别

3. **来源解析结果**
   - 显示：解析结果名称（可点击跳转到解析结果详情）
   - 用途：追溯来源

4. **使用模板**
   - 显示：模板名称（可点击查看模板）
   - 用途：了解使用的模板

5. **生成时间**
   - 显示：YYYY-MM-DD HH:mm
   - 排序：支持按时间排序

6. **更新时间**
   - 显示：最后更新时间
   - 用途：了解是否最近更新

7. **操作**
   - 预览：预览推荐报告
   - 导出Word：下载Word文档
   - 重新生成：基于原解析结果，使用新模板重新生成
   - 编辑：编辑推荐报告内容（如果支持）
   - 删除：删除推荐报告

#### 可选字段
- 原始文件（可点击下载）
- 文件大小（如果导出过）
- 状态（草稿/已完成）

---

## 五、数据关联关系设计

### 关联关系图

```
原始简历（SourceFile）
    ↓ (1对多：一个原始简历可以解析多次)
解析结果（ParsedResume）
    ↓ (1对多：一个解析结果可以用不同模板生成多个推荐报告)
推荐报告（CandidateResume，原UserResume）
```

### 数据库字段设计

#### CandidateResume（推荐报告，原UserResume）
```python
- id
- user_id                    # 猎头用户ID
- parsed_resume_id           # ✅ 新增：关联解析结果（明确来源）
- template_id                # 关联模板
- candidate_name             # ✅ 新增：候选人姓名（便于快速识别）
- resume_data                # 填充后的简历数据（JSON）
- source_file_name           # 保留：原始文件名（便于快速查看）
- source_file_type           # 保留：原始文件类型
- source_file_path           # 保留：原始文件路径（便于下载）
- title                      # 报告标题
- created_at
- updated_at
```

#### ParsedResume（解析结果）
```python
- id
- user_id                    # 猎头用户ID
- source_file_path           # ✅ 新增：直接关联原始文件路径
- source_file_name           # 原始文件名
- source_file_type           # 原始文件类型
- file_hash                  # 文件hash（用于去重）
- candidate_name             # ✅ 新增：候选人姓名（从解析数据中提取）
- parsed_data                # 解析后的结构化数据（JSON）
- validation                 # 验证结果
- correction                 # 纠错结果
- quality_analysis           # 质量分析
- created_at
- updated_at
```

#### SourceFile（原始简历，新表或使用现有逻辑）
```python
- id
- user_id                    # 猎头用户ID
- file_name                  # 文件名
- file_type                  # 文件类型
- file_path                  # 文件路径
- file_size                  # 文件大小
- file_hash                  # 文件hash（用于去重）
- created_at
- updated_at
```

### 关联查询

#### 从原始简历查询
- 查询关联的解析结果：`SELECT * FROM parsed_resumes WHERE source_file_path = ?`
- 查询关联的推荐报告：通过解析结果间接查询

#### 从解析结果查询
- 查询来源文件：通过 `source_file_path` 查询
- 查询生成的推荐报告：`SELECT * FROM candidate_resumes WHERE parsed_resume_id = ?`

#### 从推荐报告查询
- 查询来源解析结果：通过 `parsed_resume_id` 查询
- 查询原始文件：通过解析结果的 `source_file_path` 查询

---

## 六、操作流程优化

### 流程1：新上传完整流程（手动保存解析结果）

```
1. 用户上传原始简历
   ↓
2. 系统解析简历（生成解析结果，但不自动保存）
   ↓
3. 用户查看解析结果，确认无误
   ↓
4. 用户点击"保存解析结果"（手动保存到"数据中心-解析结果"）
   ↓
5. 用户选择模板
   ↓
6. 系统填充模板（生成推荐报告）
   ↓
7. 用户保存推荐报告（自动关联解析结果ID）
   ↓
8. 推荐报告保存到"数据中心-推荐报告"
```

### 流程2：基于已有解析结果

```
1. 用户在"数据中心-解析结果"选择解析结果
   ↓
2. 点击"生成推荐报告"
   ↓
3. 跳转到"简历生成"页面（带 parsedResumeId 参数）
   ↓
4. 系统自动加载解析结果
   ↓
5. 用户选择模板
   ↓
6. 系统填充模板（生成推荐报告）
   ↓
7. 用户保存推荐报告（自动关联解析结果ID）
```

### 流程3：重新生成推荐报告

```
1. 用户在"数据中心-推荐报告"选择推荐报告
   ↓
2. 点击"重新生成"
   ↓
3. 跳转到"简历生成"页面（带 parsedResumeId 参数）
   ↓
4. 系统自动加载原解析结果
   ↓
5. 用户选择新模板（或使用原模板）
   ↓
6. 系统填充模板（生成新推荐报告）
   ↓
7. 用户保存新推荐报告
```

---

## 七、数据中心页面设计

### 页面布局

```
┌─────────────────────────────────────────────────────────┐
│  数据中心                                                │
├─────────────────────────────────────────────────────────┤
│  [搜索框] [筛选] [批量操作]                              │
├─────────────────────────────────────────────────────────┤
│  Tab: [原始简历] [解析结果] [推荐报告]                    │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  [表格：当前Tab的数据列表]                                │
│                                                          │
│  - 文件名/名称 | 类型 | 时间 | 关联信息 | 操作          │
│  - ...                                                    │
│                                                          │
├─────────────────────────────────────────────────────────┤
│  [分页]                                                  │
└─────────────────────────────────────────────────────────┘
```

### 功能设计

#### 1. 统一搜索
- 搜索范围：当前Tab的数据
- 搜索字段：
  - 原始简历：文件名
  - 解析结果：名称、候选人姓名、来源文件名
  - 推荐报告：标题、候选人姓名、模板名称

#### 2. 统一筛选
- 时间范围筛选
- 状态筛选（如：已解析/未解析、已生成/未生成）
- 类型筛选（如：PDF/Word）

#### 3. 关联关系显示
- 在每个Tab中，显示关联的其他Tab数据
- 提供快捷操作，如"查看关联的解析结果"、"查看关联的推荐报告"

#### 4. 批量操作
- 批量删除
- 批量导出（推荐报告）
- 批量解析（原始简历）

---

## 八、需要讨论的问题

### 1. UserResume 重命名

**问题**：`UserResume` 字段名不合适，应该重命名为什么？

**选项**：
- A. `CandidateResume`（候选人的简历）- 推荐
- B. `RecommendedResume`（推荐报告）
- C. `ResumeReport`（简历报告）
- D. 其他建议

**影响**：
- 需要数据库迁移
- 需要修改所有相关代码
- 需要更新API接口

### 2. 数据中心页面结构

**问题**：如何组织数据中心页面？

**选项**：
- A. 独立的数据中心页面（推荐）
  - 三个Tab：原始简历、解析结果、推荐报告
  - 统一搜索、筛选、管理
- B. 保持当前结构，优化关联显示
  - "我的简历"：推荐报告 + 源文件
  - "简历解析"：解析结果
  - 在各自页面中显示关联关系

### 3. 原始简历存储方式

**问题**：原始简历是否需要独立的数据库表？

**选项**：
- A. 创建独立的 `SourceFile` 表（推荐）
  - 优点：数据结构清晰，便于管理
  - 缺点：需要数据库迁移
- B. 保持当前方式（通过 `UserResume` 和 `ParsedResume` 的 `source_file_path` 字段）
  - 优点：不需要迁移
  - 缺点：数据分散，不便于统一管理

### 4. 解析结果保存时机

**问题**：解析结果何时保存？

**选项**：
- A. 手动保存（你的倾向）
  - 优点：用户可控，减少数据库记录
  - 缺点：用户可能忘记保存
- B. 自动保存
  - 优点：避免数据丢失
  - 缺点：可能产生大量记录

### 5. 数据关联方式

**问题**：如何建立推荐报告和解析结果的关联？

**选项**：
- A. 在 `CandidateResume` 中增加 `parsed_resume_id` 字段（推荐）
  - 优点：关联明确，便于查询
  - 缺点：需要数据库迁移
- B. 通过 `file_hash` 或 `source_file_name` 智能匹配
  - 优点：不需要迁移
  - 缺点：关联不够明确，可能匹配错误

---

## 九、推荐方案总结

### 1. 重命名 UserResume
- **推荐**：`CandidateResume`（候选人的简历）
- **理由**：清晰表达业务含义，符合猎头场景

### 2. 创建数据中心页面
- **推荐**：独立的数据中心页面，三个Tab
- **理由**：统一管理，便于查看关联关系

### 3. 创建 SourceFile 表
- **推荐**：创建独立的 `SourceFile` 表
- **理由**：数据结构清晰，便于统一管理

### 4. 手动保存解析结果
- **推荐**：手动保存（你的倾向）
- **理由**：用户可控，减少不必要的记录

### 5. 建立明确关联
- **推荐**：在 `CandidateResume` 中增加 `parsed_resume_id` 字段
- **理由**：关联明确，便于查询和管理

---

## 十、实施考虑

### 数据库迁移
1. 重命名 `user_resumes` 表为 `candidate_resumes`
2. 增加 `parsed_resume_id` 字段
3. 增加 `candidate_name` 字段
4. 创建 `source_files` 表（如果采用独立表方案）

### 代码修改
1. 修改所有 `UserResume` 相关的代码
2. 修改API接口
3. 修改前端页面

### 数据迁移
1. 迁移现有数据到新表结构
2. 建立关联关系（如果可能）

---

## 十一、下一步讨论

请确认：
1. `UserResume` 重命名为 `CandidateResume` 是否合适？
2. 是否创建独立的数据中心页面？
3. 是否创建独立的 `SourceFile` 表？
4. 对于其他讨论问题，你的倾向是什么？

确认后，我可以提供详细的实施方案。

