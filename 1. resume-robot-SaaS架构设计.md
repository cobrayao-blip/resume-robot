# Resume-Robot SaaS架构设计文档

## 一、SaaS多租户架构概述

### 1.1 架构设计原则

**多租户隔离**：
- 每个企业（租户）拥有独立的数据空间
- 数据完全隔离，互不干扰
- 支持租户级别的配置和定制

**可扩展性**：
- 支持从试用版到企业版的平滑升级
- 支持按需扩展资源（用户数、处理量）
- 支持大规模并发访问

**安全性**：
- 租户数据完全隔离
- 基于角色的访问控制（RBAC）
- API级别的权限验证

---

## 二、多租户数据隔离策略

### 2.1 应用级别隔离（推荐方案）

**实现方式**：
- 所有业务表增加 `tenant_id` 字段
- 中间件自动注入 `tenant_id` 到查询条件
- 用户登录后，从JWT Token中获取 `tenant_id`
- 所有数据查询自动过滤 `tenant_id`

**优点**：
- 实现简单，维护成本低
- 支持租户间数据迁移
- 适合中小型SaaS平台

**缺点**：
- 需要确保所有查询都包含 `tenant_id`
- 数据量大时可能影响性能

**实现示例**：
```python
# 中间件自动注入 tenant_id
@app.middleware("http")
async def tenant_middleware(request: Request, call_next):
    # 从JWT Token中提取 tenant_id
    token = request.headers.get("Authorization", "").replace("Bearer ", "")
    tenant_id = get_tenant_from_token(token)
    request.state.tenant_id = tenant_id
    response = await call_next(request)
    return response

# 数据库查询自动过滤
def get_db():
    db = SessionLocal()
    # 自动添加 tenant_id 过滤条件
    return db
```

### 2.2 数据库级别隔离（可选方案）

**实现方式**：
- 每个租户有独立的数据库schema
- 动态切换数据库连接

**优点**：
- 数据完全隔离，安全性最高
- 性能最优，无跨租户查询

**缺点**：
- 实现复杂，维护成本高
- 不适合大量租户
- 数据迁移困难

**适用场景**：
- 大型企业客户（Enterprise版）
- 需要完全数据隔离的场景

---

## 三、用户权限体系

### 3.1 角色定义

#### 平台管理员（Platform Admin）
**权限**：
- 管理所有租户
- 系统配置（LLM服务、系统参数）
- 订阅管理
- 数据统计

**访问范围**：管理后台

#### 租户管理员（Tenant Admin）
**权限**：
- 管理租户内的组织架构
- 配置公司信息
- 管理筛选规则
- 管理租户内的用户
- 查看订阅信息和使用量

**访问范围**：用户侧前端（部分功能）

#### HR用户（HR User）
**权限**：
- 处理简历（上传、查看、删除）
- 管理岗位
- 查看匹配结果
- 生成推荐报告

**访问范围**：用户侧前端（核心功能）

### 3.2 权限控制实现

**API级别**：
```python
@router.get("/resumes")
async def get_resumes(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # 自动过滤 tenant_id
    resumes = db.query(Resume).filter(
        Resume.tenant_id == current_user.tenant_id
    ).all()
    return resumes
```

**前端路由级别**：
```typescript
// 路由守卫
const PrivateRoute = ({ children, requiredRole }) => {
  const { user } = useAuthStore();
  if (!user || !hasRole(user, requiredRole)) {
    return <Navigate to="/login" />;
  }
  return children;
};
```

---

## 四、管理后台设计

### 4.1 管理后台功能模块

#### 1. 租户管理
**功能**：
- 租户列表（搜索、筛选、分页）
- 租户创建（手动创建或审核注册）
- 租户详情（基本信息、订阅信息、使用统计）
- 租户操作（激活、暂停、删除）
- 租户数据统计（简历数、岗位数、匹配数、用户数）

**数据展示**：
- 租户基本信息（名称、域名、联系方式）
- 订阅信息（套餐、到期时间、使用量）
- 使用统计（简历处理量、匹配成功率）
- 用户列表（该租户的所有用户）

#### 2. 订阅管理
**功能**：
- 订阅套餐配置（trial/basic/professional/enterprise）
- 套餐参数设置（用户数、岗位数、处理量限制）
- 租户订阅列表（按套餐、状态筛选）
- 订阅续费管理（手动续费、自动续费）
- 使用量监控（实时监控各租户使用量）

**套餐配置**：
```json
{
  "code": "professional",
  "name": "专业版",
  "price_monthly": 999,
  "price_yearly": 9999,
  "max_users": 20,
  "max_jobs": 50,
  "max_resumes_per_month": 1000,
  "features": [
    "unlimited_resume_parsing",
    "advanced_matching",
    "batch_operations",
    "custom_reports"
  ]
}
```

#### 3. 系统配置
**功能**：
- LLM服务配置（DeepSeek、千问等API密钥管理）
- 系统参数配置（匹配算法权重、阈值等）
- 功能开关（邮箱接收、ATS集成等）
- 系统维护（维护模式、公告通知）

**配置项**：
- LLM API密钥（加密存储）
- 匹配算法权重（向量70% + LLM30%）
- 匹配标签阈值（强烈推荐≥85分）
- 功能开关（邮箱接收、ATS集成）

#### 4. 数据统计
**功能**：
- 平台整体统计（租户数、用户数、简历处理量）
- 租户使用情况分析（活跃度、使用量趋势）
- 匹配效果统计（匹配成功率、标签分布）
- 收入统计（SaaS订阅收入、续费率）

**统计维度**：
- 时间维度（日、周、月、年）
- 租户维度（按套餐、按行业）
- 功能维度（简历解析、匹配、报告生成）

---

## 五、用户侧前端设计（HR工作台）

### 5.1 页面结构

#### 1. 组织架构页面
**功能**：
- 部门树形结构展示（只读，由租户管理员配置）
- 部门详情查看
- 部门下的岗位列表

**交互**：
- 点击部门节点展开/收起
- 点击部门查看详情和岗位列表

#### 2. 简历管理页面
**Tab1：简历总库**
- 简历列表（表格，支持搜索、筛选、排序）
- 简历上传（拖拽上传，单文件/批量）
- 简历详情（查看解析结果）
- 简历操作（删除、关联到岗位、下载）

**Tab2：岗位简历库**
- 岗位选择器（下拉选择岗位）
- 岗位简历列表（该岗位的所有简历）
- 从岗位入口上传简历（直接进入岗位简历库）
- 批量操作（批量匹配、批量生成报告）

**Tab3：过滤箱**
- 被过滤的简历列表
- 查看过滤原因（哪个规则未通过）
- 恢复简历（重新进入匹配流程）

#### 3. 岗位管理页面
**功能**：
- 岗位列表（表格，可按部门筛选）
- 岗位创建/编辑（表单，必须选择部门）
- 岗位详情（查看岗位画像、匹配统计）
- 岗位简历库（该岗位的简历列表）
- 从岗位入口上传简历（直接进入岗位简历库）
- 岗位操作（发布、关闭、批量匹配）

**岗位详情页**：
- 基本信息（名称、部门、描述、要求）
- 岗位画像（LLM解析的结构化数据）
- 匹配统计（简历数、匹配数、标签分布）
- 岗位简历库（该岗位的简历列表）

#### 4. 匹配结果页面
**功能**：
- 匹配列表（按岗位分组，支持筛选）
- 匹配详情（查看匹配分析、优势、劣势、风险点）
- 筛选（按匹配标签、岗位、部门）
- 批量操作（批量生成报告、批量更新状态）

**匹配详情**：
- 候选人基本信息
- 匹配度分析（分数、各维度得分）
- 优势分析（3-5条）
- 劣势分析（2-3条）
- 风险点提示（1-3条）
- 推荐理由

#### 5. 推荐报告页面
**功能**：
- 报告列表（按岗位、时间排序）
- 报告生成（选择简历生成报告，单个/批量）
- 报告预览
- 报告下载（Word文档）

#### 6. 系统设置页面（租户管理员）
**Tab1：公司信息**
- 公司信息配置（行业、产品、应用场景、文化、偏好）
- 用于LLM Prompt增强

**Tab2：筛选规则**
- 规则列表（创建、编辑、启用/禁用）
- 规则类型（学历、经验、技能、年龄、地点）

**Tab3：用户管理**
- 用户列表（邀请用户、分配角色、启用/禁用）
- 用户角色（租户管理员/HR用户）

**Tab4：订阅管理**
- 订阅信息（当前套餐、到期时间）
- 使用量统计（简历数、岗位数、匹配数）
- 套餐升级（查看可用套餐、升级）

---

## 六、API设计（SaaS多租户）

### 6.1 用户侧API（自动注入tenant_id）

**简历管理**：
```
POST   /api/v1/resumes/upload                    # 上传到简历总库
POST   /api/v1/resumes/batch-upload              # 批量上传到简历总库
POST   /api/v1/jobs/{job_id}/resumes/upload      # 上传到岗位简历库
POST   /api/v1/jobs/{job_id}/resumes/batch-upload # 批量上传到岗位简历库
GET    /api/v1/resumes                          # 查询简历总库（自动过滤tenant_id）
GET    /api/v1/jobs/{job_id}/resumes            # 查询岗位简历库（自动过滤tenant_id）
GET    /api/v1/resumes/{id}                     # 获取简历详情（自动过滤tenant_id）
```

**岗位管理**：
```
POST   /api/v1/jobs                    # 创建岗位（自动关联tenant_id）
GET    /api/v1/jobs                   # 查询岗位列表（自动过滤tenant_id）
GET    /api/v1/jobs/{id}              # 获取岗位详情（自动过滤tenant_id）
```

**匹配系统**：
```
POST   /api/v1/matches/resume-to-job  # 单个简历匹配（自动关联tenant_id）
GET    /api/v1/matches                # 查询匹配结果（自动过滤tenant_id）
```

### 6.2 管理后台API（需要平台管理员权限）

**租户管理**：
```
POST   /api/v1/admin/tenants              # 创建租户
GET    /api/v1/admin/tenants              # 查询租户列表
GET    /api/v1/admin/tenants/{id}         # 获取租户详情
POST   /api/v1/admin/tenants/{id}/activate # 激活租户
POST   /api/v1/admin/tenants/{id}/suspend  # 暂停租户
GET    /api/v1/admin/tenants/{id}/stats    # 租户数据统计
```

**订阅管理**：
```
POST   /api/v1/admin/subscription/plans    # 创建套餐
PUT    /api/v1/admin/subscription/plans/{id} # 更新套餐
GET    /api/v1/admin/subscription/plans    # 查询套餐列表
POST   /api/v1/admin/tenants/{id}/subscription # 更新租户订阅
```

**系统配置**：
```
GET    /api/v1/admin/system/config          # 获取系统配置
PUT    /api/v1/admin/system/config          # 更新系统配置
GET    /api/v1/admin/system/stats           # 平台数据统计
```

---

## 七、数据模型（SaaS多租户）

### 7.1 核心表结构（所有表增加tenant_id）

```sql
-- 租户表
CREATE TABLE tenants (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    domain VARCHAR(255) UNIQUE,
    contact_email VARCHAR(255),
    contact_phone VARCHAR(50),
    subscription_plan VARCHAR(50),
    subscription_start TIMESTAMP,
    subscription_end TIMESTAMP,
    status VARCHAR(50) DEFAULT 'active',
    max_users INTEGER,
    max_jobs INTEGER,
    max_resumes_per_month INTEGER,
    current_month_resume_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 用户表（增加tenant_id）
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER REFERENCES tenants(id),
    email VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(255),
    role VARCHAR(50) DEFAULT 'hr_user', -- tenant_admin/hr_user
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(tenant_id, email)
);

-- 部门表（增加tenant_id）
CREATE TABLE departments (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER REFERENCES tenants(id),
    name VARCHAR(255) NOT NULL,
    code VARCHAR(50),
    parent_id INTEGER REFERENCES departments(id),
    level INTEGER,
    path VARCHAR(500),
    description TEXT,
    manager_id INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 岗位表（增加tenant_id）
CREATE TABLE jobs (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER REFERENCES tenants(id),
    title VARCHAR(255) NOT NULL,
    department_id INTEGER REFERENCES departments(id),
    description TEXT,
    requirements TEXT,
    status VARCHAR(50) DEFAULT 'draft',
    created_by INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 简历表（增加tenant_id）
CREATE TABLE resumes (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER REFERENCES tenants(id),
    user_id INTEGER REFERENCES users(id),
    file_name VARCHAR(255),
    file_path VARCHAR(500),
    file_hash VARCHAR(64),
    parsed_data JSONB,
    candidate_name VARCHAR(255),
    candidate_email VARCHAR(255),
    status VARCHAR(50) DEFAULT 'pending',
    source_type VARCHAR(50) DEFAULT 'talent_pool',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 岗位简历关联表（增加tenant_id）
CREATE TABLE job_resumes (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER REFERENCES tenants(id),
    job_id INTEGER REFERENCES jobs(id),
    resume_id INTEGER REFERENCES resumes(id),
    status VARCHAR(50) DEFAULT 'pending',
    filter_result JSONB,
    match_result JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(job_id, resume_id)
);

-- 筛选规则表（增加tenant_id）
CREATE TABLE filter_rules (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER REFERENCES tenants(id),
    name VARCHAR(255) NOT NULL,
    rule_type VARCHAR(50),
    rule_config JSONB NOT NULL,
    priority INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_by INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 匹配记录表（增加tenant_id）
CREATE TABLE matches (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER REFERENCES tenants(id),
    resume_id INTEGER REFERENCES resumes(id),
    job_id INTEGER REFERENCES jobs(id),
    match_score FLOAT,
    match_label VARCHAR(50),
    status VARCHAR(50) DEFAULT 'pending',
    created_by INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(resume_id, job_id)
);

-- 公司信息表（增加tenant_id，每个租户单例）
CREATE TABLE company_info (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER REFERENCES tenants(id) UNIQUE,
    name VARCHAR(255) NOT NULL,
    industry VARCHAR(100),
    products TEXT,
    application_scenarios TEXT,
    company_culture TEXT,
    preferences TEXT,
    updated_by INTEGER REFERENCES users(id),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 7.2 索引设计（优化多租户查询）

```sql
-- 所有表创建tenant_id索引
CREATE INDEX idx_users_tenant_id ON users(tenant_id);
CREATE INDEX idx_departments_tenant_id ON departments(tenant_id);
CREATE INDEX idx_jobs_tenant_id ON jobs(tenant_id);
CREATE INDEX idx_resumes_tenant_id ON resumes(tenant_id);
CREATE INDEX idx_job_resumes_tenant_id ON job_resumes(tenant_id);
CREATE INDEX idx_filter_rules_tenant_id ON filter_rules(tenant_id);
CREATE INDEX idx_matches_tenant_id ON matches(tenant_id);

-- 复合索引（tenant_id + 其他字段）
CREATE INDEX idx_jobs_tenant_status ON jobs(tenant_id, status);
CREATE INDEX idx_resumes_tenant_status ON resumes(tenant_id, status);
CREATE INDEX idx_matches_tenant_job ON matches(tenant_id, job_id);
```

---

## 八、部署架构（SaaS）

### 8.1 生产环境部署

**服务架构**：
```
┌─────────────────────────────────────────┐
│          Nginx (反向代理)                │
│    - SSL/TLS终止                         │
│    - 静态文件服务                        │
└─────────────────────────────────────────┘
           │
           ├─────────────────┬─────────────────┐
           │                 │                 │
┌──────────▼──────────┐ ┌───▼──────────┐ ┌───▼──────────┐
│  管理后台前端        │ │ 用户侧前端   │ │  API后端     │
│  (admin.domain.com) │ │ (app.domain.com) │ │ (api.domain.com) │
└─────────────────────┘ └──────────────┘ └──────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
            ┌───────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐
            │ PostgreSQL   │ │  MongoDB    │ │   Milvus    │
            │              │ │             │ │             │
            └──────────────┘ └─────────────┘ └─────────────┘
```

### 8.2 域名规划

**用户侧前端**：
- `app.resume-robot.com` - 主应用域名
- 或 `{tenant-domain}.resume-robot.com` - 租户子域名（可选）

**管理后台**：
- `admin.resume-robot.com` - 管理后台域名

**API后端**：
- `api.resume-robot.com` - API域名

### 8.3 环境变量配置

**用户侧后端**：
```env
# 多租户配置
MULTI_TENANT_ENABLED=True
TENANT_ISOLATION_MODE=application_level

# 数据库配置（共享数据库）
DATABASE_URL=postgresql://user:pass@db:5432/resume_robot

# MongoDB配置（共享数据库）
MONGODB_URL=mongodb://user:pass@mongodb:27017/resume_robot

# Milvus配置（共享）
MILVUS_HOST=milvus
MILVUS_PORT=19530
```

**管理后台后端**：
```env
# 管理后台配置
ADMIN_ENABLED=True
ADMIN_SECRET_KEY=xxx

# 共享数据库配置
DATABASE_URL=postgresql://user:pass@db:5432/resume_robot
```

---

## 九、商业化运营

### 9.1 订阅套餐设计

**Trial（试用版）**：
- 价格：免费
- 期限：14天
- 限制：5个用户，10个岗位，100份简历/月
- 功能：基础功能

**Basic（基础版）**：
- 价格：¥999/月 或 ¥9999/年
- 限制：10个用户，20个岗位，500份简历/月
- 功能：完整功能

**Professional（专业版）**：
- 价格：¥2999/月 或 ¥29999/年
- 限制：20个用户，50个岗位，1000份简历/月
- 功能：完整功能 + 批量操作 + 高级匹配

**Enterprise（企业版）**：
- 价格：定制报价
- 限制：无限制
- 功能：完整功能 + 定制化服务 + 专属支持

### 9.2 使用量监控

**监控指标**：
- 当前月简历处理量
- 当前用户数
- 当前岗位数
- 存储空间使用量

**限制策略**：
- 达到限制时，提示升级套餐
- 超过限制时，暂停相关功能
- 提供使用量预警（80%、90%、100%）

### 9.3 数据统计（管理后台）

**平台整体统计**：
- 总租户数（按套餐分布）
- 总用户数
- 总简历处理量
- 总收入（按月、按年）

**租户使用分析**：
- 活跃租户数（有登录的租户）
- 租户使用量排名
- 租户续费率
- 租户流失率

---

## 十、总结

### 10.1 SaaS架构优势

- **多租户隔离**：每个企业独立数据空间，安全可靠
- **灵活订阅**：多种套餐选择，按需付费
- **易于扩展**：支持从试用版升级到企业版
- **统一管理**：管理后台统一管理所有租户
- **商业化就绪**：完整的订阅管理和使用量监控

### 10.2 关键实现点

1. **数据隔离**：所有表增加 `tenant_id`，中间件自动过滤
2. **权限控制**：基于角色的访问控制（RBAC）
3. **使用量监控**：实时监控各租户使用量，支持限制和预警
4. **订阅管理**：灵活的套餐配置和订阅管理

### 10.3 后续优化方向

- 支持租户子域名（`{tenant}.resume-robot.com`）
- 支持租户自定义品牌（Logo、主题色）
- 支持租户数据导出（GDPR合规）
- 支持租户数据备份和恢复

