# å¤šç§Ÿæˆ·SaaSæ¶æ„å®æ–½æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. å¤šç§Ÿæˆ·ä¸­é—´ä»¶å®ç°
- âœ… åˆ›å»º `backend/app/core/tenant_middleware.py`
  - è‡ªåŠ¨ä»JWT Tokenä¸­æå–tenant_id
  - æ”¯æŒä»è¯·æ±‚å¤´ï¼ˆX-Tenant-IDï¼‰å’ŒæŸ¥è¯¢å‚æ•°ï¼ˆtenant_idï¼‰æå–
  - ç®¡ç†åå°APIè‡ªåŠ¨è·³è¿‡tenant_idæ£€æŸ¥
  - è®¤è¯APIå’Œå¥åº·æ£€æŸ¥APIè‡ªåŠ¨è·³è¿‡tenant_idæ£€æŸ¥

- âœ… åˆ›å»º `backend/app/core/tenant_dependency.py`
  - æä¾› `get_tenant_id()` å’Œ `require_tenant_id()` ä¾èµ–æ³¨å…¥å‡½æ•°
  - ç”¨äºAPIç«¯ç‚¹è‡ªåŠ¨è·å–tenant_id

- âœ… æ›´æ–° `backend/app/main.py`
  - æ·»åŠ  `TenantMiddleware` ä¸­é—´ä»¶
  - åœ¨ç›‘æ§ä¸­é—´ä»¶ä¹‹å‰æ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡å¤šç§Ÿæˆ·å¤„ç†

### 2. æ•°æ®æ¨¡å‹æ›´æ–°ï¼ˆæ‰€æœ‰è¡¨å¢åŠ tenant_idï¼‰
- âœ… `User` è¡¨ï¼šå¢åŠ  `tenant_id` å­—æ®µï¼ˆå¹³å°ç®¡ç†å‘˜ä¸ºNoneï¼‰
- âœ… `JobPosition` è¡¨ï¼šå¢åŠ  `tenant_id` å­—æ®µ
- âœ… `FilterRule` è¡¨ï¼šå¢åŠ  `tenant_id` å­—æ®µ
- âœ… `ResumeJobMatch` è¡¨ï¼šå¢åŠ  `tenant_id` å­—æ®µ
- âœ… `CompanyInfo` è¡¨ï¼šå¢åŠ  `tenant_id` å­—æ®µï¼ˆå”¯ä¸€çº¦æŸï¼Œæ¯ä¸ªç§Ÿæˆ·ä¸€æ¡è®°å½•ï¼‰
- âœ… `MatchModel` è¡¨ï¼šå¢åŠ  `tenant_id` å­—æ®µ
- âœ… `CandidateResume` è¡¨ï¼šå¢åŠ  `tenant_id` å­—æ®µ
- âœ… `ResumeTemplate` è¡¨ï¼šå¢åŠ  `tenant_id` å­—æ®µï¼ˆNoneè¡¨ç¤ºå¹³å°å…¬å…±æ¨¡æ¿ï¼‰
- âœ… `SourceFile` è¡¨ï¼šå¢åŠ  `tenant_id` å­—æ®µ
- âœ… `ParsedResume` è¡¨ï¼šå¢åŠ  `tenant_id` å­—æ®µ

### 3. ç§Ÿæˆ·ç®¡ç†æ¨¡å‹
- âœ… åˆ›å»º `Tenant` æ¨¡å‹ï¼ˆç§Ÿæˆ·è¡¨ï¼‰
  - ç§Ÿæˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆåç§°ã€åŸŸåã€è”ç³»æ–¹å¼ï¼‰
  - è®¢é˜…ä¿¡æ¯ï¼ˆå¥—é¤ã€å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ï¼‰
  - ä½¿ç”¨é™åˆ¶ï¼ˆæœ€å¤§ç”¨æˆ·æ•°ã€å²—ä½æ•°ã€ç®€å†å¤„ç†æ•°ï¼‰
  - çŠ¶æ€ç®¡ç†ï¼ˆactive/suspended/expiredï¼‰

- âœ… åˆ›å»º `SubscriptionPlan` æ¨¡å‹ï¼ˆè®¢é˜…å¥—é¤è¡¨ï¼‰
  - å¥—é¤åŸºæœ¬ä¿¡æ¯ï¼ˆåç§°ã€æ˜¾ç¤ºåç§°ã€æè¿°ï¼‰
  - ä»·æ ¼ä¿¡æ¯ï¼ˆæœˆä»·æ ¼ã€å¹´ä»·æ ¼ï¼‰
  - åŠŸèƒ½é™åˆ¶ï¼ˆç”¨æˆ·æ•°ã€å²—ä½æ•°ã€ç®€å†å¤„ç†æ•°ï¼‰
  - åŠŸèƒ½å¼€å…³ï¼ˆæ‰¹é‡æ“ä½œã€é«˜çº§åŒ¹é…ã€è‡ªå®šä¹‰æŠ¥å‘Šã€APIè®¿é—®ï¼‰

### 4. ç®¡ç†åå°APIå®ç°
- âœ… åˆ›å»º `backend/app/api/v1/admin/api.py`
  - ç»Ÿä¸€ç®¡ç†åå°APIè·¯ç”±

- âœ… åˆ›å»º `backend/app/api/v1/admin/endpoints/tenants.py`
  - `POST /api/v1/admin/tenants` - åˆ›å»ºç§Ÿæˆ·
  - `GET /api/v1/admin/tenants` - æŸ¥è¯¢ç§Ÿæˆ·åˆ—è¡¨
  - `GET /api/v1/admin/tenants/{id}` - è·å–ç§Ÿæˆ·è¯¦æƒ…
  - `PUT /api/v1/admin/tenants/{id}` - æ›´æ–°ç§Ÿæˆ·ä¿¡æ¯
  - `POST /api/v1/admin/tenants/{id}/activate` - æ¿€æ´»ç§Ÿæˆ·
  - `POST /api/v1/admin/tenants/{id}/suspend` - æš‚åœç§Ÿæˆ·
  - `GET /api/v1/admin/tenants/{id}/stats` - è·å–ç§Ÿæˆ·æ•°æ®ç»Ÿè®¡

- âœ… åˆ›å»º `backend/app/api/v1/admin/endpoints/subscriptions.py`
  - `POST /api/v1/admin/subscriptions/plans` - åˆ›å»ºè®¢é˜…å¥—é¤
  - `GET /api/v1/admin/subscriptions/plans` - æŸ¥è¯¢è®¢é˜…å¥—é¤åˆ—è¡¨
  - `GET /api/v1/admin/subscriptions/plans/{id}` - è·å–è®¢é˜…å¥—é¤è¯¦æƒ…
  - `PUT /api/v1/admin/subscriptions/plans/{id}` - æ›´æ–°è®¢é˜…å¥—é¤
  - `POST /api/v1/admin/subscriptions/tenants/{id}/subscription` - æ›´æ–°ç§Ÿæˆ·è®¢é˜…

- âœ… åˆ›å»º `backend/app/api/v1/admin/endpoints/system.py`
  - `GET /api/v1/admin/system/config` - è·å–ç³»ç»Ÿé…ç½®
  - `PUT /api/v1/admin/system/config` - æ›´æ–°ç³»ç»Ÿé…ç½®
  - `GET /api/v1/admin/system/stats` - è·å–å¹³å°æ•°æ®ç»Ÿè®¡

### 5. Schemaå®šä¹‰
- âœ… åˆ›å»º `backend/app/schemas/tenant.py`
  - `TenantCreate` - åˆ›å»ºç§Ÿæˆ·è¯·æ±‚
  - `TenantUpdate` - æ›´æ–°ç§Ÿæˆ·è¯·æ±‚
  - `TenantResponse` - ç§Ÿæˆ·å“åº”
  - `SubscriptionPlanCreate` - åˆ›å»ºè®¢é˜…å¥—é¤è¯·æ±‚
  - `SubscriptionPlanUpdate` - æ›´æ–°è®¢é˜…å¥—é¤è¯·æ±‚
  - `SubscriptionPlanResponse` - è®¢é˜…å¥—é¤å“åº”

### 6. APIè·¯ç”±æ›´æ–°
- âœ… æ›´æ–° `backend/app/api/v1/api.py`
  - åŒºåˆ†ç”¨æˆ·ä¾§APIå’Œç®¡ç†åå°API
  - ç”¨æˆ·ä¾§APIï¼š`/api/v1/*`ï¼ˆè‡ªåŠ¨æ³¨å…¥tenant_idï¼‰
  - ç®¡ç†åå°APIï¼š`/api/v1/admin/*`ï¼ˆéœ€è¦å¹³å°ç®¡ç†å‘˜æƒé™ï¼Œä¸æ³¨å…¥tenant_idï¼‰

### 7. Dockeré…ç½®æ›´æ–°
- âœ… æ›´æ–° `docker-compose.yml`
  - å°†å•ä¸ª `frontend` æœåŠ¡æ‹†åˆ†ä¸ºï¼š
    - `frontend-app`ï¼šç”¨æˆ·ä¾§å‰ç«¯ï¼ˆHRå·¥ä½œå°ï¼‰ï¼Œç«¯å£5173
    - `frontend-admin`ï¼šç®¡ç†åå°å‰ç«¯ï¼ˆå¹³å°ç®¡ç†ï¼‰ï¼Œç«¯å£5174
  - æ›´æ–°CORSé…ç½®ï¼Œæ”¯æŒä¸¤ä¸ªå‰ç«¯åŸŸå

- âœ… æ›´æ–° `docker-compose.prod.yml`
  - å°†å•ä¸ª `frontend` æœåŠ¡æ‹†åˆ†ä¸ºï¼š
    - `frontend-app`ï¼šç”¨æˆ·ä¾§å‰ç«¯ï¼ˆHRå·¥ä½œå°ï¼‰
    - `frontend-admin`ï¼šç®¡ç†åå°å‰ç«¯ï¼ˆå¹³å°ç®¡ç†ï¼‰
  - æ›´æ–°Nginxé…ç½®ï¼Œæ”¯æŒä¸¤ä¸ªå‰ç«¯è·¯å¾„ï¼ˆ/app å’Œ /adminï¼‰
  - æ›´æ–°volumesï¼Œåˆ†åˆ«ä¸ºä¸¤ä¸ªå‰ç«¯åˆ›å»ºç‹¬ç«‹çš„distå·

### 8. æ¨¡å‹å¯¼å…¥æ›´æ–°
- âœ… æ›´æ–° `backend/app/models/__init__.py`
  - å¯¼å…¥ `Tenant` å’Œ `SubscriptionPlan` æ¨¡å‹

## ğŸ“‹ å¾…å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è¿ç§»
- â³ åˆ›å»ºAlembicè¿ç§»è„šæœ¬ï¼Œä¸ºæ‰€æœ‰è¡¨æ·»åŠ tenant_idå­—æ®µ
- â³ åˆ›å»ºTenantå’ŒSubscriptionPlanè¡¨
- â³ è¿ç§»ç°æœ‰æ•°æ®ï¼ˆä¸ºç°æœ‰ç”¨æˆ·åˆ†é…é»˜è®¤ç§Ÿæˆ·ï¼‰

### 2. ç”¨æˆ·ä¾§APIæ›´æ–°
- â³ æ›´æ–°æ‰€æœ‰ç”¨æˆ·ä¾§APIç«¯ç‚¹ï¼Œä½¿ç”¨ `tenant_id` ä¾èµ–æ³¨å…¥
- â³ ç¡®ä¿æ‰€æœ‰æŸ¥è¯¢è‡ªåŠ¨è¿‡æ»¤tenant_id
- â³ ç¡®ä¿æ‰€æœ‰åˆ›å»ºæ“ä½œè‡ªåŠ¨å…³è”tenant_id

### 3. è®¤è¯ç³»ç»Ÿæ›´æ–°
- â³ æ›´æ–°ç™»å½•APIï¼Œåœ¨JWT Tokenä¸­åŒ…å«tenant_id
- â³ æ›´æ–°ç”¨æˆ·æ³¨å†Œæµç¨‹ï¼Œæ”¯æŒç§Ÿæˆ·æ³¨å†Œ
- â³ æ›´æ–°æƒé™æ£€æŸ¥ï¼ŒåŒºåˆ†å¹³å°ç®¡ç†å‘˜å’Œç§Ÿæˆ·ç®¡ç†å‘˜

### 4. å‰ç«¯å¼€å‘
- â³ å®Œå–„ç”¨æˆ·ä¾§å‰ç«¯ï¼ˆHRå·¥ä½œå°ï¼‰åŠŸèƒ½
- â³ å®Œå–„ç®¡ç†åå°å‰ç«¯ï¼ˆå¹³å°ç®¡ç†ï¼‰åŠŸèƒ½
- â³ å®ç°ç§Ÿæˆ·æ³¨å†Œå’Œæ¿€æ´»æµç¨‹

### 5. æµ‹è¯•
- â³ å•å…ƒæµ‹è¯•ï¼šå¤šç§Ÿæˆ·ä¸­é—´ä»¶
- â³ é›†æˆæµ‹è¯•ï¼šç§Ÿæˆ·æ•°æ®éš”ç¦»
- â³ ç«¯åˆ°ç«¯æµ‹è¯•ï¼šå®Œæ•´ä¸šåŠ¡æµç¨‹

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»ç­–ç•¥
é‡‡ç”¨**åº”ç”¨çº§åˆ«éš”ç¦»**ï¼ˆæ¨èæ–¹æ¡ˆï¼‰ï¼š
- æ‰€æœ‰ä¸šåŠ¡è¡¨å¢åŠ  `tenant_id` å­—æ®µ
- ä¸­é—´ä»¶è‡ªåŠ¨ä»JWT Tokenä¸­æå–tenant_id
- æ‰€æœ‰æ•°æ®æŸ¥è¯¢è‡ªåŠ¨è¿‡æ»¤tenant_id
- æ‰€æœ‰æ•°æ®åˆ›å»ºè‡ªåŠ¨å…³è”tenant_id

### æƒé™ä½“ç³»
- **å¹³å°ç®¡ç†å‘˜**ï¼ˆplatform_adminï¼‰ï¼š
  - tenant_idä¸ºNone
  - å¯ä»¥è®¿é—®ç®¡ç†åå°API
  - å¯ä»¥è·¨ç§Ÿæˆ·æ“ä½œï¼ˆæŸ¥çœ‹æ‰€æœ‰ç§Ÿæˆ·æ•°æ®ï¼‰
  
- **ç§Ÿæˆ·ç®¡ç†å‘˜**ï¼ˆtenant_adminï¼‰ï¼š
  - tenant_idä¸ä¸ºNone
  - å¯ä»¥ç®¡ç†æœ¬ç§Ÿæˆ·çš„ç”¨æˆ·å’Œé…ç½®
  - åªèƒ½è®¿é—®æœ¬ç§Ÿæˆ·çš„æ•°æ®
  
- **HRç”¨æˆ·**ï¼ˆhr_userï¼‰ï¼š
  - tenant_idä¸ä¸ºNone
  - åªèƒ½è®¿é—®æœ¬ç§Ÿæˆ·çš„æ•°æ®
  - å¯ä»¥å¤„ç†ç®€å†ã€åŒ¹é…ã€ç”ŸæˆæŠ¥å‘Š

### APIè®¾è®¡åŸåˆ™
- **ç”¨æˆ·ä¾§API**ï¼ˆ`/api/v1/*`ï¼‰ï¼š
  - è‡ªåŠ¨æ³¨å…¥tenant_id
  - æ‰€æœ‰æŸ¥è¯¢è‡ªåŠ¨è¿‡æ»¤tenant_id
  - æ‰€æœ‰åˆ›å»ºè‡ªåŠ¨å…³è”tenant_id
  
- **ç®¡ç†åå°API**ï¼ˆ`/api/v1/admin/*`ï¼‰ï¼š
  - éœ€è¦å¹³å°ç®¡ç†å‘˜æƒé™
  - ä¸æ³¨å…¥tenant_idï¼ˆå¯ä»¥è·¨ç§Ÿæˆ·æ“ä½œï¼‰
  - å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰ç§Ÿæˆ·æ•°æ®

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®è¿ç§»**ï¼šéœ€è¦ä¸ºç°æœ‰ç”¨æˆ·åˆ›å»ºé»˜è®¤ç§Ÿæˆ·ï¼Œå¹¶è¿ç§»ç°æœ‰æ•°æ®
2. **å‘åå…¼å®¹**ï¼šç¡®ä¿ç°æœ‰APIåœ¨æ·»åŠ tenant_idåä»èƒ½æ­£å¸¸å·¥ä½œ
3. **æ€§èƒ½ä¼˜åŒ–**ï¼štenant_idå­—æ®µå·²æ·»åŠ ç´¢å¼•ï¼Œç¡®ä¿æŸ¥è¯¢æ€§èƒ½
4. **å®‰å…¨æ€§**ï¼šç¡®ä¿tenant_idä¸èƒ½é€šè¿‡APIå‚æ•°ä¼ªé€ ï¼Œåªèƒ½ä»JWT Tokenä¸­è·å–

