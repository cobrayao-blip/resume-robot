# 千问和豆包基础解析增强解析规则检查报告

## 检查时间
2025-12-09

## 检查范围
- 基础解析规则（`parse_resume_text_v2`）
- 增强解析规则（`parse_resume_text`）
- Provider特定逻辑

---

## ✅ 检查结果：千问和豆包都遵循相同的规则

### 1. 基础解析（`parse_resume_text_v2`）

**位置**：`backend/app/services/llm_service.py` 第767-959行

**检查结果**：
- ✅ **统一的Prompt**：所有provider（DeepSeek、豆包、千问）使用相同的 `system_prompt` 和 `user_prompt`
- ✅ **统一的Schema**：所有provider遵循相同的JSON结构定义（第796-854行）
- ✅ **统一的规则**：所有provider遵循相同的拆分与合并规则、时间格式约束、教育背景字段区分规则等

**关键代码**：
```python
async def parse_resume_text_v2(self, raw_text: str, user=None, db_session=None):
    # ... 文本预处理 ...
    
    system_prompt = """你是资深的简历解析专家..."""  # 统一的prompt
    
    user_prompt = f"""请根据上面的【输出 JSON 结构】和约束..."""
    
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_prompt}
    ]
    
    # 调用统一的chat_completion方法，不区分provider
    response = await self.chat_completion(
        messages, 
        temperature=0.1, 
        max_tokens=8192,
        user=effective_user,
        db_session=effective_db_session
    )
```

**结论**：✅ 千问和豆包都使用相同的基础解析规则

---

### 2. 增强解析（`parse_resume_text`）

**位置**：`backend/app/services/llm_service.py` 第611-760行

**检查结果**：
- ✅ **统一的Prompt**：所有provider使用相同的增强解析prompt（第637-715行）
- ✅ **统一的Schema**：所有provider遵循相同的增强解析JSON结构（包含raw/optimized、source_paragraphs、implicit_info等）
- ✅ **统一的规则**：所有provider遵循相同的增强解析规则（段落理解、隐含信息推断、关联关系挖掘等）

**关键代码**：
```python
async def parse_resume_text(self, raw_text: str):
    # ... 文本预处理 ...
    
    system_prompt = """你是资深的简历解析专家。目标：在保持事实准确的前提下，输出**稳定、结构清晰的基础解析结果**..."""
    
    user_prompt = f"""请按照以下流程解析简历文本：
    步骤1：基础提取 + 来源记录
    步骤2：段落理解与隐含信息
    步骤3：关联与优化
    步骤4：一致性检查
    ..."""
    
    # 调用统一的chat_completion方法
    response = await self.chat_completion(messages, ...)
```

**结论**：✅ 千问和豆包都使用相同的增强解析规则

---

### 3. Provider特定逻辑检查

**检查位置**：`backend/app/services/llm_service.py`

**检查结果**：
- ✅ **`chat_completion` 方法**（第360-467行）：
  - 所有provider使用相同的prompt内容
  - 唯一区别是API endpoint的URL格式（第436-439行）：
    ```python
    if current_provider == "doubao" and "/chat/completions" in base_url:
        api_url = base_url  # 豆包的base_url已经包含完整路径
    else:
        api_url = f"{base_url}/chat/completions"  # 其他provider需要追加路径
    ```
  - 这个区别**不影响prompt内容**，只是API调用的URL格式不同

- ✅ **没有provider特定的prompt修改**：
  - 代码中没有 `if provider == "qwen"` 或 `if provider == "doubao"` 的prompt分支
  - 所有provider使用完全相同的prompt和规则

**结论**：✅ 千问和豆包没有特殊的规则差异，都遵循统一的基础解析和增强解析规则

---

## 总结

### ✅ 确认结果

1. **基础解析规则**：
   - ✅ 千问和豆包使用相同的 `parse_resume_text_v2` 方法
   - ✅ 使用相同的system_prompt和user_prompt
   - ✅ 遵循相同的JSON结构定义和解析规则

2. **增强解析规则**：
   - ✅ 千问和豆包使用相同的 `parse_resume_text` 方法
   - ✅ 使用相同的增强解析prompt
   - ✅ 遵循相同的增强解析schema和规则

3. **Provider特定逻辑**：
   - ✅ 唯一的区别是API endpoint的URL格式（不影响prompt内容）
   - ✅ 没有provider特定的prompt修改或规则差异

### 📝 注意事项

1. **API调用差异**：
   - 豆包的base_url可能已经包含 `/chat/completions` 路径
   - 千问和DeepSeek的base_url需要追加 `/chat/completions` 路径
   - **这个差异不影响prompt内容和解析规则**

2. **模型能力差异**：
   - 虽然使用相同的prompt和规则，但不同模型的**理解能力和执行效果**可能不同
   - 这是模型本身的能力差异，不是规则差异

3. **建议**：
   - 如果发现某个provider的解析结果不符合预期，可能是模型能力问题，而不是规则问题
   - 可以考虑针对特定模型优化prompt，但目前代码中没有这样的差异

---

## 相关文件

- `backend/app/services/llm_service.py` - 统一的LLM服务，所有provider使用相同的方法和规则
- `backend/app/services/resume_parser.py` - 简历解析器，调用统一的 `parse_resume_text_v2` 方法

---

## 结论

✅ **千问和豆包都遵循相同的基础解析和增强解析规则**

代码中没有针对不同provider的特殊规则处理，所有provider都使用统一的prompt和解析逻辑。唯一的差异是API调用的URL格式，这不影响prompt内容和解析规则。

