# 创建租户完整流程说明

## 一、流程概览

创建租户的完整流程涉及以下环节：
1. **前端表单** → 2. **前端API调用** → 3. **后端API处理** → 4. **数据库存储**

## 二、前端部分

### 2.1 TenantList.tsx 中的创建租户模态框

**位置**：`frontend/admin/src/pages/Tenants/TenantList.tsx`

**表单字段**：

#### 租户基本信息（必填）
- **租户名称** (`name`): 必填，例如："测试公司"
- **域名** (`domain`): 可选，例如："test-company"
- **联系人邮箱** (`contact_email`): 可选，用于联系租户
- **联系人电话** (`contact_phone`): 可选

#### 订阅信息（必填）
- **订阅套餐** (`subscription_plan`): 必填，选项：trial/basic/professional/enterprise
- **状态** (`status`): 必填，选项：active/suspended/expired

#### 使用限制（必填）
- **最大用户数** (`max_users`): 必填，数字，默认值：10
- **最大岗位数** (`max_jobs`): 必填，数字，默认值：50
- **每月最大简历处理数** (`max_resumes_per_month`): 必填，数字，默认值：500

#### 租户管理员信息（可选，仅在创建时显示）
- **管理员邮箱（账户名）** (`admin_email`): 可选
  - 说明：填写后会自动创建该邮箱对应的租户管理员账户
  - **该邮箱即为登录账户名**
  - 提示：填写后会自动创建该邮箱对应的租户管理员账户，该邮箱即为登录账户名
  
- **管理员初始密码** (`admin_password`): 可选
  - 说明：留空则使用默认密码 `Admin123456`
  - 提示：留空则使用默认密码：Admin123456（管理员首次登录后应尽快修改）
  
- **管理员姓名** (`admin_name`): 可选
  - 说明：留空则使用默认名称 `租户管理员`
  - 提示：留空则使用默认名称：租户管理员

### 2.2 数据提交逻辑

**位置**：`TenantList.tsx` 的 `handleSubmit` 函数

**处理逻辑**：
```typescript
// 创建租户时的处理
if (!editingTenant) {
  const submitData = {
    name: values.name,
    domain: values.domain || undefined,
    contact_email: values.contact_email || undefined,
    contact_phone: values.contact_phone || undefined,
    subscription_plan: values.subscription_plan || 'trial',
    status: values.status || 'active',
    max_users: parseInt(values.max_users) || 10,
    max_jobs: parseInt(values.max_jobs) || 50,
    max_resumes_per_month: parseInt(values.max_resumes_per_month) || 500,
  };
  
  // 如果填写了管理员邮箱，添加管理员信息
  if (values.admin_email) {
    submitData.admin_email = values.admin_email;
    submitData.admin_password = values.admin_password || 'Admin123456'; // 默认密码
    submitData.admin_name = values.admin_name || '租户管理员'; // 默认名称
  }
  
  await tenantApi.createTenant(submitData);
}
```

## 三、前端API接口

### 3.1 tenantApi.ts

**位置**：`frontend/admin/src/services/tenantApi.ts`

**接口定义**：
```typescript
export interface TenantCreate {
  name: string;
  domain?: string;
  contact_email?: string;
  contact_phone?: string;
  subscription_plan?: string;
  subscription_start?: string;
  subscription_end?: string;
  status?: string;
  max_users?: number;
  max_jobs?: number;
  max_resumes_per_month?: number;
  admin_email?: string;      // 租户管理员邮箱
  admin_password?: string;   // 租户管理员初始密码
  admin_name?: string;       // 租户管理员姓名
}
```

**API调用**：
```typescript
createTenant: async (data: TenantCreate) => {
  const response = await api.post('/admin/tenants', data);
  return response.data;
}
```

## 四、后端API处理

### 4.1 后端Schema定义

**位置**：`backend/app/schemas/tenant.py`

```python
class TenantCreate(TenantBase):
    """创建租户请求"""
    subscription_plan: Optional[str] = "trial"
    subscription_start: Optional[datetime] = None
    subscription_end: Optional[datetime] = None
    status: Optional[str] = "active"
    max_users: Optional[int] = 5
    max_jobs: Optional[int] = 10
    max_resumes_per_month: Optional[int] = 100
    admin_email: Optional[EmailStr] = None      # 租户管理员邮箱
    admin_password: Optional[str] = None        # 租户管理员初始密码
    admin_name: Optional[str] = None            # 租户管理员姓名
```

### 4.2 后端API处理逻辑

**位置**：`backend/app/api/v1/admin/endpoints/tenants.py`

**处理流程**：

1. **验证域名唯一性**（如果提供了域名）
2. **创建租户记录**
   ```python
   db_tenant = Tenant(
       name=tenant_data.name,
       domain=tenant_data.domain,
       contact_email=tenant_data.contact_email,
       contact_phone=tenant_data.contact_phone,
       subscription_plan=tenant_data.subscription_plan or "trial",
       subscription_start=tenant_data.subscription_start or datetime.utcnow(),
       subscription_end=tenant_data.subscription_end,
       status=tenant_data.status or "active",
       max_users=tenant_data.max_users or 5,
       max_jobs=tenant_data.max_jobs or 10,
       max_resumes_per_month=tenant_data.max_resumes_per_month or 100
   )
   db.add(db_tenant)
   db.flush()  # 获取租户ID
   ```

3. **如果提供了管理员邮箱，创建租户管理员账户**
   ```python
   if tenant_data.admin_email:
       # 检查邮箱是否已存在
       existing_user = db.query(User).filter(User.email == tenant_data.admin_email).first()
       if existing_user:
           raise HTTPException(400, detail=f"邮箱 {tenant_data.admin_email} 已被使用")
       
       # 创建租户管理员
       admin_password = tenant_data.admin_password or "Admin123456"  # 默认密码
       admin_password_hash = get_password_hash(admin_password)
       admin_user = User(
           email=tenant_data.admin_email,
           password_hash=admin_password_hash,
           full_name=tenant_data.admin_name or "租户管理员",
           role="tenant_admin",
           user_type="tenant_admin",
           tenant_id=db_tenant.id,
           is_active=True,
           is_verified=True,
           registration_status="approved"  # 自动批准
       )
       db.add(admin_user)
   ```

4. **提交事务**
   ```python
   db.commit()
   db.refresh(db_tenant)
   return db_tenant
   ```

## 五、数据库模型

### 5.1 Tenant 模型

**位置**：`backend/app/models/tenant.py`

**字段**：
- `id`: 主键
- `name`: 租户名称
- `domain`: 域名（唯一）
- `contact_email`: 联系人邮箱
- `contact_phone`: 联系人电话
- `subscription_plan`: 订阅套餐
- `subscription_start`: 订阅开始时间
- `subscription_end`: 订阅结束时间
- `status`: 状态（active/suspended/expired）
- `max_users`: 最大用户数
- `max_jobs`: 最大岗位数
- `max_resumes_per_month`: 每月最大简历处理数
- `current_month_resume_count`: 当前月已处理简历数
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 5.2 User 模型（租户管理员）

**位置**：`backend/app/models/user.py`

**关键字段**：
- `id`: 主键
- `tenant_id`: 租户ID（外键）
- `email`: 邮箱（登录账户名）
- `password_hash`: 密码哈希
- `full_name`: 姓名
- `role`: 角色（tenant_admin）
- `user_type`: 用户类型（tenant_admin）
- `is_active`: 是否激活
- `is_verified`: 是否已验证
- `registration_status`: 注册状态（approved）

## 六、使用示例

### 示例1：创建租户并同时创建管理员账户

**填写表单**：
```
租户名称：测试公司
域名：test-company
联系人邮箱：contact@test-company.com
联系人电话：13800138000
订阅套餐：trial
状态：active
最大用户数：10
最大岗位数：50
每月最大简历处理数：500

租户管理员信息：
管理员邮箱（账户名）：admin@test-company.com  ← 这就是登录账户名
管理员初始密码：（留空）← 使用默认密码 Admin123456
管理员姓名：张三
```

**创建结果**：
- ✅ 租户创建成功（ID: 1, 名称: 测试公司）
- ✅ 租户管理员账户创建成功
  - 账户名（邮箱）：`admin@test-company.com`
  - 密码：`Admin123456`
  - 姓名：`张三`
  - 角色：`tenant_admin`
  - 状态：已激活、已验证、已批准

### 示例2：仅创建租户（不创建管理员账户）

**填写表单**：
```
租户名称：测试公司
域名：test-company
联系人邮箱：contact@test-company.com
联系人电话：13800138000
订阅套餐：trial
状态：active
最大用户数：10
最大岗位数：50
每月最大简历处理数：500

租户管理员信息：
管理员邮箱（账户名）：（留空）
管理员初始密码：（留空）
管理员姓名：（留空）
```

**创建结果**：
- ✅ 租户创建成功（ID: 1, 名称: 测试公司）
- ⚠️ 未创建管理员账户，需要后续手动创建

## 七、关键点总结

1. **账户名 = 管理员邮箱**：填写在"管理员邮箱（账户名）"字段中的邮箱，就是租户管理员的登录账户名。

2. **默认密码**：
   - 如果填写了管理员邮箱但未填写密码，使用默认密码：`Admin123456`
   - 如果填写了密码，使用填写的密码

3. **默认姓名**：
   - 如果填写了管理员邮箱但未填写姓名，使用默认姓名：`租户管理员`
   - 如果填写了姓名，使用填写的姓名

4. **自动批准**：创建租户时自动创建的管理员账户会自动通过审核，无需等待。

5. **邮箱唯一性**：管理员邮箱必须在系统中全局唯一，不能与其他用户重复。

6. **数据流程**：
   ```
   前端表单 → tenantApi.createTenant() → POST /api/v1/admin/tenants
   → 后端 create_tenant() → 创建 Tenant 记录 → 创建 User 记录（如果提供了 admin_email）
   → 返回 TenantResponse
   ```

## 八、常见问题

### Q1: 创建租户时没有看到"管理员邮箱"字段？
**A**: 请确认您是在创建租户（不是编辑租户）。编辑租户时不会显示管理员信息字段。

### Q2: 管理员邮箱和联系人邮箱有什么区别？
**A**: 
- **联系人邮箱** (`contact_email`): 用于联系租户，不是登录账户
- **管理员邮箱** (`admin_email`): 用于创建租户管理员账户，是登录账户名

### Q3: 如果创建租户时没有填写管理员信息，如何创建管理员账户？
**A**: 可以通过以下方式：
1. 使用平台管理员账户登录管理后台
2. 在租户详情页面或用户管理页面创建租户管理员账户
3. 或者使用后端脚本创建

### Q4: 默认密码是什么？
**A**: 如果未填写管理员初始密码，默认密码是 `Admin123456`。管理员首次登录后应尽快修改密码。

