# 大模型Prompt优化设计方案

## 一、核心设计理念

### 1.1 组织架构作为Prompt上下文

**核心理念**：组织架构（公司-部门-岗位）信息应该成为大模型理解岗位需求和评估候选人的重要上下文。

**为什么重要**：
- **上下文增强**：帮助大模型理解岗位在整个组织中的位置和作用
- **文化匹配**：部门文化、公司文化影响对候选人的评估标准
- **精准匹配**：不同部门即使岗位名称相同，要求也可能不同（如：技术部的"产品经理" vs 市场部的"产品经理"）

### 1.2 Prompt层级结构

```
公司信息（Company Context）
  ↓
部门信息（Department Context）- 包含组织架构信息（部门层级、路径、上级部门）
  ↓
岗位信息（Job Context）
  ↓
岗位画像（Job Profile）
  ↓
候选人简历（Candidate Resume）
```

**说明**：
- **组织架构**是数据结构（公司-部门-岗位的层级关系），不是Prompt的独立层级
- **组织架构信息**应该融入到各个上下文中：
  - **公司信息**：公司层面的组织架构信息（如：公司规模、组织特点）
  - **部门信息**：部门在组织架构中的位置（层级、路径、上级部门）、部门职责、部门文化
  - **岗位信息**：岗位在组织架构中的位置（所属部门、部门层级）

## 二、当前实现分析

### 2.1 现有Prompt构建方式

#### match_service.py - 匹配分析Prompt
```python
def _build_match_analysis_prompt(
    self,
    resume_data: Dict[str, Any],
    job: JobPosition,
    job_parsed_data: Dict[str, Any],
    company_info: Optional[CompanyInfo]
) -> str:
    # 当前实现：
    # 1. 公司信息（简单字段：name, industry, preferences）
    # 2. 岗位信息（title, department, description, requirements）
    # 3. 岗位画像（结构化数据）
    # 4. 候选人简历
```

**不足**：
- ❌ 部门信息只有名称，没有部门层级、部门职责、部门文化
- ❌ 组织架构信息缺失（不知道部门在组织中的位置）
- ❌ 公司信息不够丰富（缺少产品、应用场景、公司文化的详细描述）

#### job_service.py - 岗位解析Prompt
```python
def _build_job_parsing_prompt(
    self,
    job: JobPosition,
    company_info: Optional[Dict[str, Any]] = None
) -> str:
    # 当前实现：
    # 1. 公司信息（name, industry, products, application_scenarios, company_culture, preferences）
    # 2. 岗位信息（title, department, description, requirements）
```

**不足**：
- ❌ 部门信息缺失（只有部门名称）
- ❌ 组织架构信息缺失

## 三、优化方案

### 3.1 数据模型增强

#### 需要新增/增强的模型

1. **Department（部门表）** - 需要创建
```python
class Department(Base):
    __tablename__ = "departments"
    
    id = Column(Integer, primary_key=True)
    tenant_id = Column(Integer, ForeignKey("tenants.id"), nullable=True)
    
    # 部门基本信息
    name = Column(String(255), nullable=False)  # 部门名称
    code = Column(String(50))  # 部门编码
    description = Column(Text)  # 部门职责描述
    
    # 组织架构
    parent_id = Column(Integer, ForeignKey("departments.id"), nullable=True)  # 上级部门
    level = Column(Integer)  # 部门层级（1=一级部门，2=二级部门...）
    path = Column(String(500))  # 部门路径（如：公司/技术部/研发中心）
    
    # 部门文化/特点（用于Prompt增强）
    department_culture = Column(Text)  # 部门文化
    work_style = Column(Text)  # 工作风格
    team_size = Column(Integer)  # 团队规模
    key_responsibilities = Column(Text)  # 核心职责
    
    # 关联关系
    parent = relationship("Department", remote_side=[id], backref="children")
    jobs = relationship("JobPosition", back_populates="department_obj")
```

2. **CompanyInfo（公司信息表）** - 需要增强
```python
# 当前已有字段：
- name, industry, products, application_scenarios, company_culture, preferences

# 建议新增字段：
- company_size = Column(String(50))  # 公司规模（如：100-500人）
- development_stage = Column(String(50))  # 发展阶段（如：初创期/成长期/成熟期）
- business_model = Column(Text)  # 商业模式
- core_values = Column(Text)  # 核心价值观
- recruitment_philosophy = Column(Text)  # 招聘理念
```

3. **JobPosition（岗位表）** - 需要增强关联
```python
# 当前已有：
- department = Column(String(100))  # 部门名称（字符串）

# 建议增强：
- department_id = Column(Integer, ForeignKey("departments.id"), nullable=True)  # 关联部门表
- department_obj = relationship("Department", back_populates="jobs")
```

### 3.2 Prompt构建服务

#### 创建统一的Prompt构建服务

```python
# backend/app/services/prompt_builder.py

class PromptBuilder:
    """Prompt构建服务 - 统一管理所有LLM Prompt的构建"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def build_company_context(self, tenant_id: int) -> str:
        """构建公司上下文"""
        company = self.db.query(CompanyInfo).filter(
            CompanyInfo.tenant_id == tenant_id
        ).first()
        
        if not company:
            return ""
        
        parts = []
        parts.append("## 公司信息")
        parts.append(f"公司名称: {company.name}")
        if company.industry:
            parts.append(f"所属行业: {company.industry}")
        if company.products:
            parts.append(f"主要产品/服务: {company.products}")
        if company.application_scenarios:
            parts.append(f"应用场景: {company.application_scenarios}")
        if company.company_culture:
            parts.append(f"公司文化: {company.company_culture}")
        if company.preferences:
            parts.append(f"招聘偏好: {company.preferences}")
        if company.company_size:
            parts.append(f"公司规模: {company.company_size}")
        if company.development_stage:
            parts.append(f"发展阶段: {company.development_stage}")
        if company.core_values:
            parts.append(f"核心价值观: {company.core_values}")
        if company.recruitment_philosophy:
            parts.append(f"招聘理念: {company.recruitment_philosophy}")
        
        return "\n".join(parts)
    
    def build_organization_context(self, department_id: int) -> str:
        """构建组织架构上下文（部门层级信息）"""
        department = self.db.query(Department).filter(
            Department.id == department_id
        ).first()
        
        if not department:
            return ""
        
        parts = []
        parts.append("## 组织架构信息")
        
        # 部门路径（展示完整层级）
        if department.path:
            parts.append(f"部门路径: {department.path}")
        else:
            # 如果没有path，手动构建
            path_parts = []
            current = department
            while current:
                path_parts.insert(0, current.name)
                current = current.parent
            parts.append(f"部门路径: {' / '.join(path_parts)}")
        
        # 部门基本信息
        parts.append(f"部门名称: {department.name}")
        if department.code:
            parts.append(f"部门编码: {department.code}")
        if department.level:
            parts.append(f"部门层级: 第{department.level}级部门")
        
        # 部门职责和文化
        if department.description:
            parts.append(f"部门职责: {department.description}")
        if department.key_responsibilities:
            parts.append(f"核心职责: {department.key_responsibilities}")
        if department.department_culture:
            parts.append(f"部门文化: {department.department_culture}")
        if department.work_style:
            parts.append(f"工作风格: {department.work_style}")
        if department.team_size:
            parts.append(f"团队规模: {department.team_size}人")
        
        # 上级部门信息（如果有）
        if department.parent:
            parts.append(f"上级部门: {department.parent.name}")
            if department.parent.description:
                parts.append(f"上级部门职责: {department.parent.description}")
        
        return "\n".join(parts)
    
    def build_job_context(
        self,
        job: JobPosition,
        include_profile: bool = True
    ) -> str:
        """构建岗位上下文"""
        parts = []
        parts.append("## 岗位信息")
        parts.append(f"岗位名称: {job.title}")
        
        # 部门信息（如果有关联）
        if job.department_obj:
            parts.append(f"所属部门: {job.department_obj.name}")
        elif job.department:
            parts.append(f"所属部门: {job.department}")
        
        if job.description:
            parts.append(f"\n岗位描述:\n{job.description}")
        if job.requirements:
            parts.append(f"\n岗位要求:\n{job.requirements}")
        
        # 岗位画像（如果包含）
        if include_profile and job.mongodb_id:
            profile = mongodb_service.get_job_profile(job.id)
            if profile:
                parts.append("\n## 岗位画像（结构化）")
                parts.append(json.dumps(
                    profile.get("parsed_data", {}),
                    ensure_ascii=False,
                    indent=2
                ))
        
        return "\n".join(parts)
    
    def build_match_analysis_prompt(
        self,
        resume_data: Dict[str, Any],
        job: JobPosition,
        job_parsed_data: Optional[Dict[str, Any]] = None
    ) -> str:
        """构建匹配分析Prompt（完整版）"""
        prompt_parts = []
        
        # 1. 公司上下文
        if job.tenant_id:
            company_context = self.build_company_context(job.tenant_id)
            if company_context:
                prompt_parts.append(company_context)
                prompt_parts.append("")
        
        # 2. 部门上下文（包含组织架构信息）
        if job.department_id:
            dept_context = self.build_department_context(job.department_id)
            if dept_context:
                prompt_parts.append(dept_context)
                prompt_parts.append("")
        
        # 3. 岗位上下文
        job_context = self.build_job_context(job, include_profile=True)
        prompt_parts.append(job_context)
        prompt_parts.append("")
        
        # 4. 候选人简历
        prompt_parts.append("## 候选人简历")
        prompt_parts.append(json.dumps(resume_data, ensure_ascii=False, indent=2))
        prompt_parts.append("")
        
        # 5. 分析要求
        prompt_parts.append("## 分析要求")
        prompt_parts.append("""
请根据以上信息，进行深度匹配分析。特别注意：

1. **组织匹配**：
   - 考虑候选人的工作风格是否匹配部门文化
   - 考虑候选人的团队协作能力是否适合团队规模
   - 考虑候选人的经验是否匹配部门的核心职责

2. **岗位匹配**：
   - 评估候选人的技能、经验、学历是否符合岗位要求
   - 评估候选人的职业发展路径是否与岗位匹配

3. **文化匹配**：
   - 评估候选人的价值观是否匹配公司核心价值观
   - 评估候选人的工作理念是否匹配公司招聘理念

4. **风险识别**：
   - 识别候选人可能不适合该岗位/部门/公司的风险点
   - 识别候选人可能不适合该行业/应用场景的风险点

输出JSON格式：
""")
        prompt_parts.append(json.dumps({
            "score": "匹配度分数（0-10，浮点数）",
            "strengths": {
                "organization_match": ["组织匹配优势1", "组织匹配优势2"],
                "job_match": ["岗位匹配优势1", "岗位匹配优势2"],
                "culture_match": ["文化匹配优势1", "文化匹配优势2"]
            },
            "weaknesses": {
                "organization_mismatch": ["组织不匹配点1"],
                "job_mismatch": ["岗位不匹配点1"],
                "culture_mismatch": ["文化不匹配点1"]
            },
            "risk_points": {
                "department_risk": ["部门相关风险点"],
                "company_risk": ["公司相关风险点"],
                "industry_risk": ["行业相关风险点"]
            },
            "recommendation": "推荐建议（强烈推荐/推荐/谨慎推荐/不推荐）",
            "detailed_analysis": "详细分析说明（包含组织匹配、岗位匹配、文化匹配的综合分析）"
        }, ensure_ascii=False, indent=2))
        
        return "\n".join(prompt_parts)
    
    def build_job_parsing_prompt(
        self,
        job: JobPosition
    ) -> str:
        """构建岗位解析Prompt（完整版）"""
        prompt_parts = []
        
        # 1. 公司上下文
        if job.tenant_id:
            company_context = self.build_company_context(job.tenant_id)
            if company_context:
                prompt_parts.append(company_context)
                prompt_parts.append("")
        
        # 2. 部门上下文（包含组织架构信息）
        if job.department_id:
            dept_context = self.build_department_context(job.department_id)
            if dept_context:
                prompt_parts.append(dept_context)
                prompt_parts.append("")
        
        # 3. 岗位信息
        prompt_parts.append("## 岗位信息")
        prompt_parts.append(f"岗位名称: {job.title}")
        if job.department_obj:
            prompt_parts.append(f"所属部门: {job.department_obj.name}")
        elif job.department:
            prompt_parts.append(f"所属部门: {job.department}")
        if job.description:
            prompt_parts.append(f"\n岗位描述:\n{job.description}")
        if job.requirements:
            prompt_parts.append(f"\n岗位要求:\n{job.requirements}")
        prompt_parts.append("")
        
        # 4. 输出要求
        prompt_parts.append("## 输出要求")
        prompt_parts.append("""
请根据以上信息，提取结构化的岗位画像。特别注意：

1. **结合组织架构**：
   - 考虑部门的核心职责，理解岗位在部门中的定位
   - 考虑部门文化，理解岗位对候选人的软性要求
   - 考虑部门层级，理解岗位的汇报关系和协作范围

2. **结合公司信息**：
   - 考虑行业特点，理解岗位对行业经验的要求
   - 考虑应用场景，理解岗位对特定场景经验的要求
   - 考虑公司文化，理解岗位对价值观匹配的要求

输出JSON格式：
""")
        # ... JSON格式定义 ...
        
        return "\n".join(prompt_parts)
```

### 3.3 服务层更新

#### 更新 match_service.py

```python
# 使用 PromptBuilder 构建Prompt
from ..services.prompt_builder import PromptBuilder

class MatchService:
    def __init__(self, db_session: Session, llm_service: Optional[LLMService] = None):
        self.db = db_session
        self.llm_service = llm_service or LLMService()
        self.prompt_builder = PromptBuilder(db_session)  # 新增
    
    async def match_resume_to_job(
        self,
        resume_id: int,
        job_id: int,
        match_model: Optional[MatchModel] = None
    ) -> Dict[str, Any]:
        # ... 获取数据 ...
        
        # 使用 PromptBuilder 构建Prompt
        prompt = self.prompt_builder.build_match_analysis_prompt(
            resume_data=resume_data,
            job=job,
            job_parsed_data=job_parsed_data
        )
        
        # 调用LLM
        llm_analysis = await self.llm_service.chat_completion(
            messages=[
                {"role": "system", "content": self._get_match_system_prompt()},
                {"role": "user", "content": prompt}
            ],
            temperature=0.3,
            response_format={"type": "json_object"}
        )
        
        # ... 后续处理 ...
```

#### 更新 job_service.py

```python
# 使用 PromptBuilder 构建Prompt
from ..services.prompt_builder import PromptBuilder

class JobService:
    def __init__(self, db_session: Session, llm_service: Optional[LLMService] = None):
        self.db = db_session
        self.llm_service = llm_service or LLMService()
        self.prompt_builder = PromptBuilder(db_session)  # 新增
    
    async def parse_job_profile(self, job_id: int) -> Dict[str, Any]:
        # ... 获取岗位信息 ...
        
        # 使用 PromptBuilder 构建Prompt
        prompt = self.prompt_builder.build_job_parsing_prompt(job)
        
        # 调用LLM
        parsed_data = await self.llm_service.chat_completion(
            messages=[
                {"role": "system", "content": self._get_system_prompt()},
                {"role": "user", "content": prompt}
            ],
            temperature=0.3,
            response_format={"type": "json_object"}
        )
        
        # ... 后续处理 ...
```

## 四、实施步骤

### 4.1 第一阶段：数据模型增强

1. ✅ 创建 Department 表（组织架构）
2. ✅ 增强 CompanyInfo 表（新增字段）
3. ✅ 增强 JobPosition 表（关联 department_id）

### 4.2 第二阶段：Prompt构建服务

1. ⏳ 创建 `PromptBuilder` 服务类
2. ⏳ 实现 `build_company_context` 方法
3. ⏳ 实现 `build_department_context` 方法（包含组织架构信息）
4. ⏳ 实现 `build_job_context` 方法
5. ⏳ 实现 `build_match_analysis_prompt` 方法（完整版）
6. ⏳ 实现 `build_job_parsing_prompt` 方法（完整版）

### 4.3 第三阶段：服务层更新

1. ⏳ 更新 `match_service.py` 使用 PromptBuilder
2. ⏳ 更新 `job_service.py` 使用 PromptBuilder
3. ⏳ 测试验证Prompt效果

## 五、预期效果

### 5.1 Prompt质量提升

**之前**：
- 只有简单的公司信息（名称、行业、偏好）
- 只有部门名称，没有部门上下文
- 匹配分析不够深入

**之后**：
- 完整的公司上下文（规模、阶段、文化、理念）
- 完整的组织架构上下文（部门层级、职责、文化、风格）
- 更精准的匹配分析（组织匹配、岗位匹配、文化匹配）

### 5.2 匹配精度提升

- **组织匹配**：评估候选人是否适合该部门/团队
- **文化匹配**：评估候选人是否匹配公司/部门文化
- **风险识别**：更准确地识别组织、文化、行业相关的风险点

## 六、总结

通过将组织架构信息整合到Prompt中，可以让大模型：
1. **更好地理解岗位**：知道岗位在组织中的位置和作用
2. **更精准地匹配**：不仅看技能匹配，还看组织匹配和文化匹配
3. **更准确地评估**：识别组织、文化、行业相关的风险点

这是一个非常重要的优化方向，可以显著提升简历匹配的质量和准确性。

