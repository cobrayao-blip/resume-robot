# MongoDB 文档结构设计文档

## 概述

本文档定义了 Resume-Robot 项目中 MongoDB 的文档结构。MongoDB 用于存储：
1. 岗位画像数据（从 LLM 解析得到）
2. 简历解析结果（从 PostgreSQL 迁移）
3. 匹配详情（向量相似度、规则匹配、LLM 分析等）

---

## 1. 岗位画像文档（job_profiles）

### 集合名称
`job_profiles`

### 文档结构
```javascript
{
  _id: ObjectId,                    // MongoDB自动生成
  job_id: 123,                     // PostgreSQL中的job_positions.id
  parsed_data: {                   // 岗位解析数据
    title: "高级Python开发工程师",
    requirements: {
      education: {
        degree: "本科及以上",
        major: ["计算机科学", "软件工程", "相关专业"]
      },
      experience: {
        years: 3,
        fields: ["Python", "Django", "PostgreSQL", "Redis"]
      },
      skills: ["Python", "Django", "PostgreSQL", "Redis", "Docker"],
      location: "北京",
      salary_range: "20k-35k"
    },
    description: "负责后端系统开发，参与架构设计...",
    preferences: {
      reliability: "高",
      security: "高",
      innovation: "中"
    }
  },
  parsed_at: ISODate("2025-01-01T10:00:00Z"),
  created_at: ISODate("2025-01-01T10:00:00Z"),
  updated_at: ISODate("2025-01-01T10:00:00Z")
}
```

### 索引
- `job_id`: 唯一索引（一个岗位对应一个画像）

### 使用场景
- 岗位发布后，通过 LLM 解析岗位描述和要求，生成结构化画像
- 用于简历匹配时的岗位要求对比

---

## 2. 简历解析结果文档（parsed_resumes）

### 集合名称
`parsed_resumes`

### 文档结构
```javascript
{
  _id: ObjectId,                    // MongoDB自动生成
  parsed_resume_id: 456,            // PostgreSQL中的parsed_resumes.id
  parsed_data: {                     // 简历解析数据（从PostgreSQL迁移）
    basic_info: {
      name: "张三",
      phone: "13800138000",
      email: "zhangsan@example.com",
      location: "北京"
    },
    work_experiences: [
      {
        company: "XX公司",
        position: "Python开发工程师",
        start_date: "2020-01",
        end_date: "2023-12",
        description: "负责..."
      }
    ],
    education: [
      {
        school: "XX大学",
        degree: "本科",
        major: "计算机科学",
        graduation_date: "2020-06"
      }
    ],
    skills: {
      programming_languages: ["Python", "Java"],
      frameworks: ["Django", "Flask"],
      databases: ["PostgreSQL", "MySQL"]
    },
    projects: [
      {
        name: "XX项目",
        role: "核心开发",
        description: "..."
      }
    ]
  },
  metadata: {                        // 元数据
    source: "postgresql_migration",  // 数据来源
    migrated_at: ISODate("2025-01-01T10:00:00Z")
  },
  created_at: ISODate("2025-01-01T10:00:00Z"),
  updated_at: ISODate("2025-01-01T10:00:00Z")
}
```

### 索引
- `parsed_resume_id`: 唯一索引（一个解析结果对应一个文档）

### 使用场景
- 从 PostgreSQL 的 `parsed_resumes.parsed_data` 字段迁移到 MongoDB
- 用于简历匹配时的数据读取（避免 PostgreSQL JSON 字段查询性能问题）

---

## 3. 匹配详情文档（match_details）

### 集合名称
`match_details`

### 文档结构
```javascript
{
  _id: ObjectId,                    // MongoDB自动生成
  match_id: 789,                    // PostgreSQL中的resume_job_matches.id
  vector_similarity: 0.85,          // 向量相似度分数（0-1）
  vector_details: {                 // 向量匹配详情
    skill_similarity: 0.88,
    experience_similarity: 0.82,
    project_similarity: 0.80,
    combined_similarity: 0.85
  },
  rule_match_result: {              // 规则匹配结果
    passed: true,
    failed_rules: [],
    rule_details: [
      {
        rule_id: 1,
        rule_name: "学历要求",
        passed: true,
        reason: "候选人学历为本科，满足要求"
      },
      {
        rule_id: 2,
        rule_name: "工作经验",
        passed: true,
        reason: "候选人具有5年Python开发经验，满足3年以上要求"
      }
    ]
  },
  llm_analysis: {                   // LLM深度分析结果
    score: 8.5,                     // LLM评分（0-10）
    strengths: [
      "具有丰富的Python开发经验",
      "熟悉Django框架，有大型项目经验",
      "掌握PostgreSQL数据库优化"
    ],
    weaknesses: [
      "缺少微服务架构经验",
      "对云原生技术了解较少"
    ],
    risk_points: [
      "跳槽频率较高（3年换2次工作）"
    ],
    recommendation: "强烈推荐",
    detailed_analysis: "候选人具有5年Python开发经验，熟练掌握Django框架和PostgreSQL数据库。曾在XX公司负责核心业务系统开发，具备良好的技术能力和项目经验。虽然缺少微服务架构经验，但学习能力强，可以快速适应。"
  },
  score_breakdown: {                // 评分明细
    vector_score: 8.2,              // 向量相似度转换后的分数（0-10）
    rule_score: 10.0,               // 规则匹配分数（0-10，全部通过为10）
    llm_score: 8.5,                 // LLM评分（0-10）
    final_score: 8.5,               // 最终综合分数
    weights: {
      vector: 0.3,
      rule: 0.2,
      llm: 0.5
    },
    calculation: "8.2 * 0.3 + 10.0 * 0.2 + 8.5 * 0.5 = 8.5"
  },
  created_at: ISODate("2025-01-01T10:00:00Z"),
  updated_at: ISODate("2025-01-01T10:00:00Z")
}
```

### 索引
- `match_id`: 唯一索引（一个匹配记录对应一个详情文档）

### 使用场景
- 存储简历与岗位匹配的详细分析过程
- 用于前端展示匹配详情（优势、劣势、风险点等）
- 用于匹配算法的优化和调试

---

## 4. 数据迁移策略

### 4.1 简历解析结果迁移

**迁移时机**：
- 系统升级时一次性迁移
- 新解析结果实时写入 MongoDB

**迁移脚本**：
```python
# 从PostgreSQL读取parsed_resumes表
# 将parsed_data字段迁移到MongoDB
# 更新PostgreSQL中的parsed_resumes表，添加mongodb_id字段（可选）
```

### 4.2 数据一致性

**策略**：
- PostgreSQL 存储元数据和关联关系
- MongoDB 存储详细数据（JSON 文档）
- 通过 ID 关联（job_id, parsed_resume_id, match_id）

**更新流程**：
1. 更新 PostgreSQL 元数据
2. 更新 MongoDB 文档
3. 使用事务或最终一致性保证

---

## 5. 查询优化

### 5.1 索引设计

**岗位画像**：
- `job_id`: 唯一索引

**简历解析结果**：
- `parsed_resume_id`: 唯一索引

**匹配详情**：
- `match_id`: 唯一索引

### 5.2 查询模式

**常见查询**：
1. 根据 job_id 查询岗位画像
2. 根据 parsed_resume_id 查询解析结果
3. 根据 match_id 查询匹配详情

**批量查询**：
- 使用 `$in` 操作符批量查询多个文档

---

## 6. 数据模型类

Python 代码中定义了 Pydantic 模型（`backend/app/models/mongodb_models.py`）用于：
- 类型提示
- 数据验证
- 文档结构说明

实际使用时，直接使用字典（Dict[str, Any]）操作 MongoDB 文档。

---

## 7. 服务层封装

`backend/app/core/mongodb_service.py` 提供了：
- `save_job_profile()`: 保存岗位画像
- `get_job_profile()`: 获取岗位画像
- `save_parsed_resume()`: 保存解析结果
- `get_parsed_resume()`: 获取解析结果
- `save_match_detail()`: 保存匹配详情
- `get_match_detail()`: 获取匹配详情

---

## 8. 注意事项

1. **数据备份**：定期备份 MongoDB 数据
2. **数据迁移**：迁移时注意数据一致性
3. **性能优化**：合理使用索引，避免全表扫描
4. **数据清理**：定期清理过期或无效数据
5. **版本兼容**：文档结构变更时考虑向后兼容

---

**最后更新**: 2025-01-XX  
**版本**: 1.0.0

